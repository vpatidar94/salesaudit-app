!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("@angular/common")):"function"==typeof define&&define.amd?define("ngx-img-cropper",["exports","@angular/core","@angular/common"],e):e((t=t||self)["ngx-img-cropper"]={},t.ng.core,t.ng.common)}(this,(function(t,e,i){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var o=function(t,e){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};function r(t,e){function i(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}function s(t,e,i,o){var r,s=arguments.length,n=s<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(t,e,i,o);else for(var a=t.length-1;a>=0;a--)(r=t[a])&&(n=(s<3?r(n):s>3?r(e,i,n):r(e,i))||n);return s>3&&n&&Object.defineProperty(e,i,n),n}function n(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)}function a(t){var e="function"==typeof Symbol&&t[Symbol.iterator],i=0;return e?e.call(t):{next:function(){return t&&i>=t.length&&(t=void 0),{value:t&&t[i++],done:!t}}}}var h=function(t){this.lineDash=!1,this.strokeWidth=1,this.strokeColor="rgba(255,255,255,1)",this.fillColor="rgba(255,255,255,1)",this.dragIconStrokeWidth=1,this.dragIconStrokeColor="rgba(0,0,0,1)",this.dragIconFillColor="rgba(255,255,255,1)",this.backgroundFillColor="rgba(0,0,0,0.6)","object"==typeof t&&(this.lineDash=t.lineDash||this.lineDash,this.strokeWidth=t.strokeWidth||this.strokeWidth,this.fillColor=t.fillColor||this.fillColor,this.strokeColor=t.strokeColor||this.strokeColor,this.dragIconStrokeWidth=t.dragIconStrokeWidth||this.dragIconStrokeWidth,this.dragIconStrokeColor=t.dragIconStrokeColor||this.dragIconStrokeColor,this.dragIconFillColor=t.dragIconFillColor||this.dragIconFillColor,this.backgroundFillColor=t.backgroundFillColor||this.backgroundFillColor)},p=function(){function t(t){this.canvasWidth=300,this.canvasHeight=300,this.dynamicSizing=!1,this.width=200,this.height=200,this.minWidth=50,this.minHeight=50,this.minWithRelativeToResolution=!0,this.croppedWidth=100,this.croppedHeight=100,this.cropperDrawSettings=new h,this.touchRadius=20,this.noFileInput=!1,this.markerSizeMultiplier=1,this.centerTouchRadius=20,this.showCenterMarker=!0,this.allowedFilesRegex=/\.(jpe?g|png|gif|bmp)$/i,this.cropOnResize=!0,this.preserveSize=!1,this.compressRatio=1,this._rounded=!1,this._keepAspect=!0,"object"==typeof t&&Object.assign(this,t)}return Object.defineProperty(t.prototype,"rounded",{get:function(){return this._rounded},set:function(t){this._rounded=t,t&&(this._keepAspect=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"keepAspect",{get:function(){return this._keepAspect},set:function(t){this._keepAspect=t,!0===this._rounded&&!1===this._keepAspect&&(console.error("Cannot set keep aspect to false on rounded cropper. Ellipsis not supported"),this._keepAspect=!0)},enumerable:!0,configurable:!0}),t}(),c=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),e}(Number),g=function(){function t(){this.debug=!1,this.IptcFieldMap={120:"caption",110:"credit",25:"keywords",55:"dateCreated",80:"byline",85:"bylineTitle",122:"captionWriter",105:"headline",116:"copyright",15:"category"},this.Tags={36864:"ExifVersion",40960:"FlashpixVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37500:"MakerNote",37510:"UserComment",40964:"RelatedSoundFile",36867:"DateTimeOriginal",36868:"DateTimeDigitized",37520:"SubsecTime",37521:"SubsecTimeOriginal",37522:"SubsecTimeDigitized",33434:"ExposureTime",33437:"FNumber",34850:"ExposureProgram",34852:"SpectralSensitivity",34855:"ISOSpeedRatings",34856:"OECF",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBias",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37396:"SubjectArea",37386:"FocalLength",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41492:"SubjectLocation",41493:"ExposureIndex",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRation",41989:"FocalLengthIn35mmFilm",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",40965:"InteroperabilityIFDPointer",42016:"ImageUniqueID"},this.TiffTags={256:"ImageWidth",257:"ImageHeight",34665:"ExifIFDPointer",34853:"GPSInfoIFDPointer",40965:"InteroperabilityIFDPointer",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",274:"Orientation",277:"SamplesPerPixel",284:"PlanarConfiguration",530:"YCbCrSubSampling",531:"YCbCrPositioning",282:"XResolution",283:"YResolution",296:"ResolutionUnit",273:"StripOffsets",278:"RowsPerStrip",279:"StripByteCounts",513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength",301:"TransferFunction",318:"WhitePoint",319:"PrimaryChromaticities",529:"YCbCrCoefficients",532:"ReferenceBlackWhite",306:"DateTime",270:"ImageDescription",271:"Make",272:"Model",305:"Software",315:"Artist",33432:"Copyright"},this.GPSTags={0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential"},this.StringValues={ExposureProgram:{0:"Not defined",1:"Manual",2:"Normal program",3:"Aperture priority",4:"Shutter priority",5:"Creative program",6:"Action program",7:"Portrait mode",8:"Landscape mode"},MeteringMode:{0:"Unknown",1:"Average",2:"CenterWeightedAverage",3:"Spot",4:"MultiSpot",5:"Pattern",6:"Partial",255:"Other"},LightSource:{0:"Unknown",1:"Daylight",2:"Fluorescent",3:"Tungsten (incandescent light)",4:"Flash",9:"Fine weather",10:"Cloudy weather",11:"Shade",12:"Daylight fluorescent (D 5700 - 7100K)",13:"Day white fluorescent (N 4600 - 5400K)",14:"Cool white fluorescent (W 3900 - 4500K)",15:"White fluorescent (WW 3200 - 3700K)",17:"Standard light A",18:"Standard light B",19:"Standard light C",20:"D55",21:"D65",22:"D75",23:"D50",24:"ISO studio tungsten",255:"Other"},Flash:{0:"Flash did not fire",1:"Flash fired",5:"Strobe return light not detected",7:"Strobe return light detected",9:"Flash fired, compulsory flash mode",13:"Flash fired, compulsory flash mode, return light not detected",15:"Flash fired, compulsory flash mode, return light detected",16:"Flash did not fire, compulsory flash mode",24:"Flash did not fire, auto mode",25:"Flash fired, auto mode",29:"Flash fired, auto mode, return light not detected",31:"Flash fired, auto mode, return light detected",32:"No flash function",65:"Flash fired, red-eye reduction mode",69:"Flash fired, red-eye reduction mode, return light not detected",71:"Flash fired, red-eye reduction mode, return light detected",73:"Flash fired, compulsory flash mode, red-eye reduction mode",77:"Flash fired, compulsory flash mode, red-eye reduction mode, return light not detected",79:"Flash fired, compulsory flash mode, red-eye reduction mode, return light detected",89:"Flash fired, auto mode, red-eye reduction mode",93:"Flash fired, auto mode, return light not detected, red-eye reduction mode",95:"Flash fired, auto mode, return light detected, red-eye reduction mode"},SensingMethod:{1:"Not defined",2:"One-chip color area sensor",3:"Two-chip color area sensor",4:"Three-chip color area sensor",5:"Color sequential area sensor",7:"Trilinear sensor",8:"Color sequential linear sensor"},SceneCaptureType:{0:"Standard",1:"Landscape",2:"Portrait",3:"Night scene"},SceneType:{1:"Directly photographed"},CustomRendered:{0:"Normal process",1:"Custom process"},WhiteBalance:{0:"Auto white balance",1:"Manual white balance"},GainControl:{0:"None",1:"Low gain up",2:"High gain up",3:"Low gain down",4:"High gain down"},Contrast:{0:"Normal",1:"Soft",2:"Hard"},Saturation:{0:"Normal",1:"Low saturation",2:"High saturation"},Sharpness:{0:"Normal",1:"Soft",2:"Hard"},SubjectDistanceRange:{0:"Unknown",1:"Macro",2:"Close view",3:"Distant view"},FileSource:{3:"DSC"},Components:{0:"",1:"Y",2:"Cb",3:"Cr",4:"R",5:"G",6:"B"}}}return t.prototype.addEvent=function(t,e,i){t.addEventListener?t.addEventListener(e,i,!1):t.attachEvent&&t.attachEvent("on"+e,i)},t.prototype.imageHasData=function(t){return!!t.exifdata},t.prototype.base64ToArrayBuffer=function(t){t=t.replace(/^data:([^;]+);base64,/gim,"");for(var e=atob(t),i=e.length,o=new ArrayBuffer(i),r=new Uint8Array(o),s=0;s<i;s++)r[s]=e.charCodeAt(s);return o},t.prototype.objectURLToBlob=function(t,e){var i=new XMLHttpRequest;i.open("GET",t,!0),i.responseType="blob",i.onload=function(){200!==i.status&&0!==i.status||e(i.response)},i.send()},t.prototype.getImageData=function(t,e){var i=this,o=function(o){var r=i.findEXIFinJPEG(o),s=i.findIPTCinJPEG(o);t.exifdata=r||{},t.iptcdata=s||{},e&&e.call(t)};if("src"in t&&t.src)if(/^data:/i.test(t.src)){var r=this.base64ToArrayBuffer(t.src);o(r)}else if(/^blob:/i.test(t.src)){var s=new FileReader;s.onload=function(t){o(t.target.result)},this.objectURLToBlob(t.src,(function(t){s.readAsArrayBuffer(t)}))}else{var n=new XMLHttpRequest;n.onload=function(){if(200!==n.status&&0!==n.status)throw new Error("Could not load image");o(n.response)},n.open("GET",t.src,!0),n.responseType="arraybuffer",n.send(null)}else if(FileReader&&(t instanceof Blob||t instanceof File)){var a=new FileReader;a.onload=function(t){i.log("Got file of length "+t.target.result.byteLength),o(t.target.result)},a.readAsArrayBuffer(t)}},t.prototype.findEXIFinJPEG=function(t){var e=new DataView(t);if(this.log("Got file of length "+t.byteLength),255!==e.getUint8(0)||216!==e.getUint8(1))return this.log("Not a valid JPEG"),!1;for(var i,o=2,r=t.byteLength;o<r;){if(255!==e.getUint8(o))return this.log("Not a valid marker at offset "+o+", found: "+e.getUint8(o)),!1;if(i=e.getUint8(o+1),this.log(i),225===i)return this.log("Found 0xFFE1 marker"),this.readEXIFData(e,o+4);o+=2+e.getUint16(o+2)}},t.prototype.findIPTCinJPEG=function(t){var e=new DataView(t);if(this.log("Got file of length "+t.byteLength),255!==e.getUint8(0)||216!==e.getUint8(1))return this.log("Not a valid JPEG"),!1;for(var i,o,r=2,s=t.byteLength;r<s;){if(o=r,56===(i=e).getUint8(o)&&66===i.getUint8(o+1)&&73===i.getUint8(o+2)&&77===i.getUint8(o+3)&&4===i.getUint8(o+4)&&4===i.getUint8(o+5)){var n=e.getUint8(r+7);n%2!=0&&(n+=1),0===n&&(n=4);var a=r+8+n,h=e.getUint16(r+6+n);return this.readIPTCData(t,a,h)}r++}},t.prototype.readIPTCData=function(t,e,i){for(var o,r,s,n,a=new DataView(t),h={},p=e;p<e+i;)28===a.getUint8(p)&&2===a.getUint8(p+1)&&(n=a.getUint8(p+2))in this.IptcFieldMap&&((s=a.getInt16(p+3))+5,r=this.IptcFieldMap[n],o=this.getStringFromDB(a,p+5,s),h.hasOwnProperty(r)?h[r]instanceof Array?h[r].push(o):h[r]=[h[r],o]:h[r]=o),p++;return h},t.prototype.readTags=function(t,e,i,o,r){for(var s,n,a=t.getUint16(i,!r),h={},p=0;p<a;p++)s=i+12*p+2,(n=o[t.getUint16(s,!r)])||this.log("Unknown tag: "+t.getUint16(s,!r)),h[n]=this.readTagValue(t,s,e,i,r);return h},t.prototype.readTagValue=function(t,e,i,o,r){var s,n,a,h,p,g,u=t.getUint16(e+2,!r),d=t.getUint32(e+4,!r),l=t.getUint32(e+8,!r)+i;switch(u){case 1:case 7:if(1===d)return t.getUint8(e+8,!r);for(s=d>4?l:e+8,n=[],h=0;h<d;h++)n[h]=t.getUint8(s+h);return n;case 2:return s=d>4?l:e+8,this.getStringFromDB(t,s,d-1);case 3:if(1===d)return t.getUint16(e+8,!r);for(s=d>2?l:e+8,n=[],h=0;h<d;h++)n[h]=t.getUint16(s+2*h,!r);return n;case 4:if(1===d)return t.getUint32(e+8,!r);for(n=[],h=0;h<d;h++)n[h]=t.getUint32(l+4*h,!r);return n;case 5:if(1===d)return p=t.getUint32(l,!r),g=t.getUint32(l+4,!r),(a=new c(p/g)).numerator=p,a.denominator=g,a;for(n=[],h=0;h<d;h++)p=t.getUint32(l+8*h,!r),g=t.getUint32(l+4+8*h,!r),n[h]=new c(p/g),n[h].numerator=p,n[h].denominator=g;return n;case 9:if(1===d)return t.getInt32(e+8,!r);for(n=[],h=0;h<d;h++)n[h]=t.getInt32(l+4*h,!r);return n;case 10:if(1===d)return t.getInt32(l,!r)/t.getInt32(l+4,!r);for(n=[],h=0;h<d;h++)n[h]=t.getInt32(l+8*h,!r)/t.getInt32(l+4+8*h,!r);return n}},t.prototype.getStringFromDB=function(t,e,i){for(var o="",r=e;r<e+i;r++)o+=String.fromCharCode(t.getUint8(r));return o},t.prototype.readEXIFData=function(t,e){if("Exif"!==this.getStringFromDB(t,e,4))return this.log("Not valid EXIF data! "+this.getStringFromDB(t,e,4)),!1;var i,o,r,s,n,a=e+6;if(18761===t.getUint16(a))i=!1;else{if(19789!==t.getUint16(a))return this.log("Not valid TIFF data! (no 0x4949 or 0x4D4D)"),!1;i=!0}if(42!==t.getUint16(a+2,!i))return this.log("Not valid TIFF data! (no 0x002A)"),!1;var h=t.getUint32(a+4,!i);if(h<8)return this.log("Not valid TIFF data! (First offset less than 8)",t.getUint32(a+4,!i)),!1;if((o=this.readTags(t,a,a+h,this.TiffTags,i)).ExifIFDPointer)for(r in s=this.readTags(t,a,a+o.ExifIFDPointer,this.Tags,i))if({}.hasOwnProperty.call(s,r)){switch(r){case"LightSource":case"Flash":case"MeteringMode":case"ExposureProgram":case"SensingMethod":case"SceneCaptureType":case"SceneType":case"CustomRendered":case"WhiteBalance":case"GainControl":case"Contrast":case"Saturation":case"Sharpness":case"SubjectDistanceRange":case"FileSource":s[r]=this.StringValues[r][s[r]];break;case"ExifVersion":case"FlashpixVersion":s[r]=String.fromCharCode(s[r][0],s[r][1],s[r][2],s[r][3]);break;case"ComponentsConfiguration":s[r]=this.StringValues.Components[s[r][0]]+this.StringValues.Components[s[r][1]]+this.StringValues.Components[s[r][2]]+this.StringValues.Components[s[r][3]]}o[r]=s[r]}if(o.GPSInfoIFDPointer)for(r in n=this.readTags(t,a,a+o.GPSInfoIFDPointer,this.GPSTags,i))if({}.hasOwnProperty.call(n,r)){switch(r){case"GPSVersionID":n[r]=n[r][0]+"."+n[r][1]+"."+n[r][2]+"."+n[r][3]}o[r]=n[r]}return o},t.prototype.checkImageType=function(t){return t instanceof Image||t instanceof HTMLImageElement},t.prototype.getData=function(t,e){return!(this.checkImageType(t)&&!t.complete)&&(this.imageHasData(t)?e&&e.call(t):this.getImageData(t,e),!0)},t.prototype.getTag=function(t,e){if(this.imageHasData(t))return t.exifdata[e]},t.prototype.getAllTags=function(t){if(!this.imageHasData(t))return{};var e,i=t.exifdata,o={};for(e in i)i.hasOwnProperty(e)&&(o[e]=i[e]);return o},t.prototype.pretty=function(t){if(!this.imageHasData(t))return"";var e,i=t.exifdata,o="";for(e in i)i.hasOwnProperty(e)&&("object"==typeof i[e]?i[e]instanceof Number?o+=e+" : "+i[e]+" ["+i[e].numerator+"/"+i[e].denominator+"]\r\n":o+=e+" : ["+i[e].length+" values]\r\n":o+=e+" : "+i[e]+"\r\n");return o},t.prototype.readFromBinaryFile=function(t){return this.findEXIFinJPEG(t)},t.prototype.log=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.debug&&console.log(t)},t}(),u=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}return Object.defineProperty(t.prototype,"next",{get:function(){return this.myNext},set:function(t){this.myNext=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"prev",{get:function(){return this.myPrev},set:function(t){this.myPrev=t},enumerable:!0,configurable:!0}),t}(),d=function(){function t(t){void 0===t&&(t=1);for(var e=this.firstAvailable=new u,i=1;i<t;i++){var o=new u;e.next=o,e=o}}return Object.defineProperty(t.prototype,"instance",{get:function(){return this},enumerable:!0,configurable:!0}),t.prototype.borrow=function(t,e){if(null==this.firstAvailable)throw new Error("Pool exhausted");this.borrowed++;var i=this.firstAvailable;return this.firstAvailable=i.next,i.x=t,i.y=e,i},t.prototype.returnPoint=function(t){this.borrowed--,t.x=0,t.y=0,t.next=this.firstAvailable,this.firstAvailable=t},t}(),l=function(){function t(t,e,i,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===o&&(o=0),this.left=t,this.right=t+i,this.top=e,this.bottom=e+o}return Object.defineProperty(t.prototype,"width",{get:function(){return this.right-this.left},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this.bottom-this.top},enumerable:!0,configurable:!0}),t.prototype.getCentre=function(){var t=this.width,e=this.height;return(new d).instance.borrow(this.left+t/2,this.top+e/2)},t}(),f=function(){function t(t,e,i,o){this.cropperSettings=new p,this.over=!1,this.drag=!1,this._position=new u(t,e),this.offset=new u(0,0),this.radius=i,this.cropperSettings=o}return t.prototype.setDrag=function(t){this.drag=t,this.setOver(t)},t.prototype.draw=function(t){},t.prototype.setOver=function(t){this.over=t},t.prototype.touchInBounds=function(t,e){return t>this.position.x-this.radius+this.offset.x&&t<this.position.x+this.radius+this.offset.x&&e>this.position.y-this.radius+this.offset.y&&e<this.position.y+this.radius+this.offset.y},Object.defineProperty(t.prototype,"position",{get:function(){return this._position},enumerable:!0,configurable:!0}),t.prototype.setPosition=function(t,e){this._position.x=t,this._position.y=e},t}(),m=function(t){function e(e,i,o,r){return t.call(this,e,i,o,r)||this}return r(e,t),e.prototype.drawCornerBorder=function(t){var e=10;(this.over||this.drag)&&(e=12);var i=this.cropperSettings.markerSizeMultiplier,o=this.cropperSettings.markerSizeMultiplier;this.horizontalNeighbour.position.x<this.position.x&&(i=-this.cropperSettings.markerSizeMultiplier),this.verticalNeighbour.position.y<this.position.y&&(o=-this.cropperSettings.markerSizeMultiplier),t.beginPath(),this.cropperSettings.cropperDrawSettings.lineDash&&t.setLineDash([1,3]),t.lineJoin="miter",t.moveTo(this.position.x+this.offset.x,this.position.y+this.offset.y),t.lineTo(this.position.x+this.offset.x+e*i,this.position.y+this.offset.y),t.lineTo(this.position.x+this.offset.x+e*i,this.position.y+this.offset.y+e*o),t.lineTo(this.position.x+this.offset.x,this.position.y+this.offset.y+e*o),t.lineTo(this.position.x+this.offset.x,this.position.y+this.offset.y),t.closePath(),t.lineWidth=this.cropperSettings.cropperDrawSettings.strokeWidth,t.strokeStyle=this.cropperSettings.cropperDrawSettings.strokeColor||"rgba(255,255,255,.7)",t.stroke()},e.prototype.drawCornerFill=function(t){var e=10;(this.over||this.drag)&&(e=12);var i=this.cropperSettings.markerSizeMultiplier,o=this.cropperSettings.markerSizeMultiplier;if(this.horizontalNeighbour.position.x<this.position.x&&(i=-this.cropperSettings.markerSizeMultiplier),this.verticalNeighbour.position.y<this.position.y&&(o=-this.cropperSettings.markerSizeMultiplier),this.cropperSettings.rounded){var r=this.position.x-this.horizontalNeighbour.position.x,s=this.position.y-this.verticalNeighbour.position.y,n=Math.round(Math.sin(Math.PI/2)*Math.abs(r/2))/4,a=Math.round(Math.sin(Math.PI/2)*Math.abs(s/2))/4;this.offset.x=i>0?n:-n,this.offset.y=o>0?a:-a}else this.offset.x=0,this.offset.y=0;t.beginPath(),this.cropperSettings.cropperDrawSettings.lineDash&&t.setLineDash([1,3]),t.moveTo(this.position.x+this.offset.x,this.position.y+this.offset.y),t.lineTo(this.position.x+this.offset.x+e*i,this.position.y+this.offset.y),t.lineTo(this.position.x+this.offset.x+e*i,this.position.y+this.offset.y+e*o),t.lineTo(this.position.x+this.offset.x,this.position.y+this.offset.y+e*o),t.lineTo(this.position.x+this.offset.x,this.position.y+this.offset.y),t.closePath(),t.fillStyle=this.cropperSettings.cropperDrawSettings.fillColor||"rgba(255,255,255,.7)",t.fill()},e.prototype.moveX=function(t){this.setPosition(t,this.position.y)},e.prototype.moveY=function(t){this.setPosition(this.position.x,t)},e.prototype.move=function(t,e){this.setPosition(t,e),this.verticalNeighbour.moveX(t),this.horizontalNeighbour.moveY(e)},e.prototype.addHorizontalNeighbour=function(t){this.horizontalNeighbour=t},e.prototype.addVerticalNeighbour=function(t){this.verticalNeighbour=t},e.prototype.getHorizontalNeighbour=function(){return this.horizontalNeighbour},e.prototype.getVerticalNeighbour=function(){return this.verticalNeighbour},e.prototype.draw=function(t){this.drawCornerFill(t),this.drawCornerBorder(t)},e}(f),v=function(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.id=i,this.x=t,this.y=e},y=function(t){function e(e,i,o,r){var s=t.call(this,e,i,o,r)||this;return s.iconPoints=[],s.scaledIconPoints=[],s.getDragIconPoints(s.iconPoints,1),s.getDragIconPoints(s.scaledIconPoints,1.2),s}return r(e,t),e.prototype.draw=function(t){this.over||this.drag?this.drawIcon(t,this.scaledIconPoints):this.drawIcon(t,this.iconPoints)},e.prototype.getDragIconPoints=function(t,e){var i=17*e,o=14*e,r=8*e,s=4*e;t.push((new d).instance.borrow(-s/2,i-r)),t.push((new d).instance.borrow(-o/2,i-r)),t.push((new d).instance.borrow(0,i)),t.push((new d).instance.borrow(o/2,i-r)),t.push((new d).instance.borrow(s/2,i-r)),t.push((new d).instance.borrow(s/2,s/2)),t.push((new d).instance.borrow(i-r,s/2)),t.push((new d).instance.borrow(i-r,o/2)),t.push((new d).instance.borrow(i,0)),t.push((new d).instance.borrow(i-r,-o/2)),t.push((new d).instance.borrow(i-r,-s/2)),t.push((new d).instance.borrow(s/2,-s/2)),t.push((new d).instance.borrow(s/2,-i+r)),t.push((new d).instance.borrow(o/2,-i+r)),t.push((new d).instance.borrow(0,-i)),t.push((new d).instance.borrow(-o/2,-i+r)),t.push((new d).instance.borrow(-s/2,-i+r)),t.push((new d).instance.borrow(-s/2,-s/2)),t.push((new d).instance.borrow(-i+r,-s/2)),t.push((new d).instance.borrow(-i+r,-o/2)),t.push((new d).instance.borrow(-i,0)),t.push((new d).instance.borrow(-i+r,o/2)),t.push((new d).instance.borrow(-i+r,s/2)),t.push((new d).instance.borrow(-s/2,s/2))},e.prototype.drawIcon=function(t,e){var i,o;if(this.cropperSettings.showCenterMarker){t.beginPath(),t.moveTo(e[0].x+this.position.x,e[0].y+this.position.y);try{for(var r=a(e),s=r.next();!s.done;s=r.next()){var n=s.value;t.lineTo(n.x+this.position.x,n.y+this.position.y)}}catch(t){i={error:t}}finally{try{s&&!s.done&&(o=r.return)&&o.call(r)}finally{if(i)throw i.error}}t.closePath(),t.fillStyle=this.cropperSettings.cropperDrawSettings.dragIconFillColor,t.fill(),t.lineWidth=this.cropperSettings.cropperDrawSettings.dragIconStrokeWidth,t.strokeStyle=this.cropperSettings.cropperDrawSettings.dragIconStrokeColor,t.stroke()}},e.prototype.recalculatePosition=function(t){var e=t.getCentre();this.setPosition(e.x,e.y),(new d).instance.returnPoint(e)},e}(f),w=function(){},C=function(){function t(){this.share={}}return t.prototype.setPressed=function(t){this.pressed=t},t.prototype.setReleased=function(t){this.pressed},t.prototype.setOver=function(t){this.over=t},t.prototype.setStyle=function(t,e){void 0!==this.pressed?this.pressed:this.over},t}(),b=function(t){function e(e){var i=t.call(this)||this;i.imageCropperDataShare=new C;var o=e.width,r=e.height,s=e.keepAspect,n=e.touchRadius,a=e.centerTouchRadius,h=e.minWidth,p=e.minHeight,c=e.croppedWidth,g=e.croppedHeight;return i.cropperSettings=e,i.crop=i,i.x=0,i.y=0,i.canvasHeight=e.canvasHeight,i.canvasWidth=e.canvasWidth,i.width=o,void 0===o&&(i.width=100),i.height=r,void 0===r&&(i.height=50),i.keepAspect=s,void 0===s&&(i.keepAspect=!0),i.touchRadius=n,void 0===n&&(i.touchRadius=20),i.minWidth=h,i.minHeight=p,i.aspectRatio=0,i.currentDragTouches=[],i.isMouseDown=!1,i.ratioW=1,i.ratioH=1,i.fileType=e.fileType,i.imageSet=!1,i.pointPool=new d(200),i.tl=new m(0,0,n,i.cropperSettings),i.tr=new m(0+o,0,n,i.cropperSettings),i.bl=new m(0,0+r,n,i.cropperSettings),i.br=new m(0+o,0+r,n,i.cropperSettings),i.tl.addHorizontalNeighbour(i.tr),i.tl.addVerticalNeighbour(i.bl),i.tr.addHorizontalNeighbour(i.tl),i.tr.addVerticalNeighbour(i.br),i.bl.addHorizontalNeighbour(i.br),i.bl.addVerticalNeighbour(i.tl),i.br.addHorizontalNeighbour(i.bl),i.br.addVerticalNeighbour(i.tr),i.markers=[i.tl,i.tr,i.bl,i.br],i.center=new y(0+o/2,0+r/2,a,i.cropperSettings),i.aspectRatio=r/o,i.croppedImage=new Image,i.currentlyInteracting=!1,i.cropWidth=c,i.cropHeight=g,i}return r(e,t),e.prototype.sign=function(t){return+t===t?0===t?t:t>0?1:-1:NaN},e.prototype.getMousePos=function(t,e){var i=t.getBoundingClientRect();return(new d).instance.borrow(e.clientX-i.left,e.clientY-i.top)},e.prototype.getTouchPos=function(t,e){var i=t.getBoundingClientRect();return(new d).instance.borrow(e.clientX-i.left,e.clientY-i.top)},e.prototype.detectVerticalSquash=function(t){var e=t.height,i=document.createElement("canvas");i.width=1,i.height=e;var o=i.getContext("2d");o.drawImage(t,0,0);var r=o.getImageData(0,0,1,e);if(r){for(var s=r.data,n=0,a=e,h=e;h>n;){0===s[4*(h-1)+3]?a=h:n=h,h=a+n>>1}var p=h/e;return 0===p?1:p}return 1},e.prototype.getDataUriMimeType=function(t){var e=t.substring(0,50),i="image/png",o=RegExp(/^(data:)([\w\/\+]+);(charset=[\w-]+|base64).*,(.*)/gi).exec(e);return o&&o[2]&&"image/jpg"===(i=o[2])&&(i="image/jpeg"),i},e.prototype.prepare=function(t){this.buffer=document.createElement("canvas"),this.cropCanvas=document.createElement("canvas");var e=t.parentElement?t.parentElement.clientWidth:0;e>0&&this.cropperSettings.dynamicSizing?(this.cropCanvas.width=e,this.buffer.width=e,t.width=e):(this.cropCanvas.width=this.cropWidth,this.buffer.width=t.width),this.cropCanvas.height=this.cropHeight,this.buffer.height=t.height,this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.draw(this.ctx)},e.prototype.updateSettings=function(t){this.cropperSettings=t},e.prototype.resizeCanvas=function(t,e,i){void 0===i&&(i=!1),this.canvas.width=this.cropCanvas.width=this.width=this.canvasWidth=this.buffer.width=t,this.canvas.height=this.cropCanvas.height=this.height=this.canvasHeight=this.buffer.height=e,i&&this.setImage(this.srcImage)},e.prototype.reset=function(){this.setImage(void 0)},e.prototype.draw=function(t){var e=this.getBounds();if(this.srcImage){t.clearRect(0,0,this.canvasWidth,this.canvasHeight);var i=this.srcImage.height/this.srcImage.width,o=this.canvasHeight/this.canvasWidth,r=this.canvasWidth,s=this.canvasHeight;o>i?(r=this.canvasWidth,s=this.canvasWidth*i):(s=this.canvasHeight,r=this.canvasHeight/i),this.ratioW=r/this.srcImage.width,this.ratioH=s/this.srcImage.height,o<i?this.drawImageIOSFix(t,this.srcImage,0,0,this.srcImage.width,this.srcImage.height,this.buffer.width/2-r/2,0,r,s):this.drawImageIOSFix(t,this.srcImage,0,0,this.srcImage.width,this.srcImage.height,0,this.buffer.height/2-s/2,r,s),this.buffer.getContext("2d").drawImage(this.canvas,0,0,this.canvasWidth,this.canvasHeight),t.lineWidth=this.cropperSettings.cropperDrawSettings.strokeWidth,t.strokeStyle=this.cropperSettings.cropperDrawSettings.strokeColor,t.fillStyle=this.cropperSettings.cropperDrawSettings.backgroundFillColor,this.cropperSettings.rounded?(t.fillRect(0,0,this.canvas.width,this.canvas.height),t.save(),t.beginPath(),t.arc(e.left+e.width/2,e.top+e.height/2,e.width/2,0,2*Math.PI),t.stroke(),t.clip(),o<i?this.drawImageIOSFix(t,this.srcImage,0,0,this.srcImage.width,this.srcImage.height,this.buffer.width/2-r/2,0,r,s):this.drawImageIOSFix(t,this.srcImage,0,0,this.srcImage.width,this.srcImage.height,0,this.buffer.height/2-s/2,r,s),t.restore()):(t.fillRect(0,0,this.canvasWidth,this.canvasHeight),t.drawImage(this.buffer,e.left,e.top,Math.max(e.width,1),Math.max(e.height,1),e.left,e.top,e.width,e.height),t.strokeRect(e.left,e.top,e.width,e.height));for(var n=0;n<this.markers.length;n++)this.markers[n].draw(t);this.center.draw(t)}else t.fillStyle="rgba(192,192,192,1)",t.fillRect(0,0,this.canvas.width,this.canvas.height)},e.prototype.dragCenter=function(t,e,i){var o=this.getBounds(),r=t-o.width/2,s=t+o.width/2,n=e-o.height/2,a=e+o.height/2;s>=this.maxXClamp&&(t=this.maxXClamp-o.width/2),r<=this.minXClamp&&(t=o.width/2+this.minXClamp),n<this.minYClamp&&(e=o.height/2+this.minYClamp),a>=this.maxYClamp&&(e=this.maxYClamp-o.height/2),this.tl.moveX(t-o.width/2),this.tl.moveY(e-o.height/2),this.tr.moveX(t+o.width/2),this.tr.moveY(e-o.height/2),this.bl.moveX(t-o.width/2),this.bl.moveY(e+o.height/2),this.br.moveX(t+o.width/2),this.br.moveY(e+o.height/2),i.setPosition(t,e)},e.prototype.enforceMinSize=function(t,e,i){var o=t-i.getHorizontalNeighbour().position.x,r=e-i.getVerticalNeighbour().position.y,s=this.minWidth-Math.abs(o),n=this.minHeight-Math.abs(r);return 0===o||0===r?(t=i.position.x,e=i.position.y,(new d).instance.borrow(t,e)):(this.keepAspect?s>0&&n/this.aspectRatio>0?s>n/this.aspectRatio?o<0?(t-=s,r<0?e-=s*this.aspectRatio:e+=s*this.aspectRatio):(t+=s,r<0?e-=s*this.aspectRatio:e+=s*this.aspectRatio):r<0?(e-=n,o<0?t-=n/this.aspectRatio:t+=n/this.aspectRatio):(e+=n,o<0?t-=n/this.aspectRatio:t+=n/this.aspectRatio):s>0?o<0?(t-=s,r<0?e-=s*this.aspectRatio:e+=s*this.aspectRatio):(t+=s,r<0?e-=s*this.aspectRatio:e+=s*this.aspectRatio):n>0&&(r<0?(e-=n,o<0?t-=n/this.aspectRatio:t+=n/this.aspectRatio):(e+=n,o<0?t-=n/this.aspectRatio:t+=n/this.aspectRatio)):(s>0&&(o<0?t-=s:t+=s),n>0&&(r<0?e-=n:e+=n)),(t<this.minXClamp||t>this.maxXClamp||e<this.minYClamp||e>this.maxYClamp)&&(t=i.position.x,e=i.position.y),(new d).instance.borrow(t,e))},e.prototype.dragCorner=function(t,e,i){var o,r=0,s=0,n=0,a=0,h=0,p=0,c=0,g=0,u=0;if(this.keepAspect){if(n=(o=i.getHorizontalNeighbour().getVerticalNeighbour()).position.x,a=o.position.y,t<=o.position.x){if(e<=o.position.y){if(r=n-100/this.aspectRatio,s=a-100/this.aspectRatio*this.aspectRatio,(u=this.getSide((new d).instance.borrow(r,s),o.position,(new d).instance.borrow(t,e)))>0){p=(h=Math.abs(o.position.y-e))/this.aspectRatio,c=o.position.y-h,g=o.position.x-p;var l=this.enforceMinSize(g,c,i);i.move(l.x,l.y),(new d).instance.returnPoint(l)}else if(u<0){h=(p=Math.abs(o.position.x-t))*this.aspectRatio,c=o.position.y-h,g=o.position.x-p;l=this.enforceMinSize(g,c,i);i.move(l.x,l.y),(new d).instance.returnPoint(l)}}else if(r=n-100/this.aspectRatio,s=a+100/this.aspectRatio*this.aspectRatio,(u=this.getSide((new d).instance.borrow(r,s),o.position,(new d).instance.borrow(t,e)))>0){h=(p=Math.abs(o.position.x-t))*this.aspectRatio,c=o.position.y+h,g=o.position.x-p;l=this.enforceMinSize(g,c,i);i.move(l.x,l.y),(new d).instance.returnPoint(l)}else if(u<0){p=(h=Math.abs(o.position.y-e))/this.aspectRatio,c=o.position.y+h,g=o.position.x-p;l=this.enforceMinSize(g,c,i);i.move(l.x,l.y),(new d).instance.returnPoint(l)}}else if(e<=o.position.y){if(r=n+100/this.aspectRatio,s=a-100/this.aspectRatio*this.aspectRatio,(u=this.getSide((new d).instance.borrow(r,s),o.position,(new d).instance.borrow(t,e)))<0){p=(h=Math.abs(o.position.y-e))/this.aspectRatio,c=o.position.y-h,g=o.position.x+p;l=this.enforceMinSize(g,c,i);i.move(l.x,l.y),(new d).instance.returnPoint(l)}else if(u>0){h=(p=Math.abs(o.position.x-t))*this.aspectRatio,c=o.position.y-h,g=o.position.x+p;l=this.enforceMinSize(g,c,i);i.move(l.x,l.y),(new d).instance.returnPoint(l)}}else if(r=n+100/this.aspectRatio,s=a+100/this.aspectRatio*this.aspectRatio,(u=this.getSide((new d).instance.borrow(r,s),o.position,(new d).instance.borrow(t,e)))<0){h=(p=Math.abs(o.position.x-t))*this.aspectRatio,c=o.position.y+h,g=o.position.x+p;l=this.enforceMinSize(g,c,i);i.move(l.x,l.y),(new d).instance.returnPoint(l)}else if(u>0){p=(h=Math.abs(o.position.y-e))/this.aspectRatio,c=o.position.y+h,g=o.position.x+p;l=this.enforceMinSize(g,c,i);i.move(l.x,l.y),(new d).instance.returnPoint(l)}}else{l=this.enforceMinSize(t,e,i);i.move(l.x,l.y),(new d).instance.returnPoint(l)}this.center.recalculatePosition(this.getBounds())},e.prototype.getSide=function(t,e,i){var o=this.sign((e.x-t.x)*(i.y-t.y)-(e.y-t.y)*(i.x-t.x));return(new d).instance.returnPoint(t),(new d).instance.returnPoint(i),o},e.prototype.handleRelease=function(t){if(null!=t){for(var e=0,i=0;i<this.currentDragTouches.length;i++)t.id===this.currentDragTouches[i].id&&(this.currentDragTouches[i].dragHandle.setDrag(!1),e=i);this.currentDragTouches.splice(e,1),this.draw(this.ctx)}},e.prototype.handleMove=function(t){for(var e,i,o=!1,r=0;r<this.currentDragTouches.length;r++)if(t.id===this.currentDragTouches[r].id&&null!=this.currentDragTouches[r].dragHandle){var s=this.currentDragTouches[r],n=this.clampPosition(t.x-s.dragHandle.offset.x,t.y-s.dragHandle.offset.y);t.x=n.x,t.y=n.y,(new d).instance.returnPoint(n),s.dragHandle instanceof m?this.dragCorner(t.x,t.y,s.dragHandle):this.dragCenter(t.x,t.y,s.dragHandle),this.currentlyInteracting=!0,o=!0,this.imageCropperDataShare.setPressed(this.canvas);break}if(!o){try{for(var h=a(this.markers),p=h.next();!p.done;p=h.next()){var c=p.value;if(c.touchInBounds(t.x,t.y)){t.dragHandle=c,this.currentDragTouches.push(t),c.setDrag(!0),t.dragHandle.offset.x=t.x-t.dragHandle.position.x,t.dragHandle.offset.y=t.y-t.dragHandle.position.y,this.dragCorner(t.x-t.dragHandle.offset.x,t.y-t.dragHandle.offset.y,t.dragHandle);break}}}catch(t){e={error:t}}finally{try{p&&!p.done&&(i=h.return)&&i.call(h)}finally{if(e)throw e.error}}null!==t.dragHandle&&void 0!==t.dragHandle||this.center.touchInBounds(t.x,t.y)&&(t.dragHandle=this.center,this.currentDragTouches.push(t),t.dragHandle.setDrag(!0),t.dragHandle.offset.x=t.x-t.dragHandle.position.x,t.dragHandle.offset.y=t.y-t.dragHandle.position.y,this.dragCenter(t.x-t.dragHandle.offset.x,t.y-t.dragHandle.offset.y,t.dragHandle))}},e.prototype.updateClampBounds=function(){var t=this.srcImage.height/this.srcImage.width,e=this.canvas.height/this.canvas.width,i=this.canvas.width,o=this.canvas.height;e>t?(i=this.canvas.width,o=this.canvas.width*t):(o=this.canvas.height,i=this.canvas.height/t),this.minXClamp=this.canvas.width/2-i/2,this.minYClamp=this.canvas.height/2-o/2,this.maxXClamp=this.canvas.width/2+i/2,this.maxYClamp=this.canvas.height/2+o/2},e.prototype.getCropBounds=function(){var t=this.getBounds();return t.top=Math.round((t.top-this.minYClamp)/this.ratioH),t.bottom=Math.round((t.bottom-this.minYClamp)/this.ratioH),t.left=Math.round((t.left-this.minXClamp)/this.ratioW),t.right=Math.round((t.right-this.minXClamp)/this.ratioW),t},e.prototype.clampPosition=function(t,e){return t<this.minXClamp&&(t=this.minXClamp),t>this.maxXClamp&&(t=this.maxXClamp),e<this.minYClamp&&(e=this.minYClamp),e>this.maxYClamp&&(e=this.maxYClamp),(new d).instance.borrow(t,e)},e.prototype.isImageSet=function(){return this.imageSet},e.prototype.setImage=function(t){if(this.srcImage=t,t){this.imageSet=!0,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.buffer.getContext("2d").clearRect(0,0,this.buffer.width,this.buffer.height),this.cropperSettings.fileType||(this.fileType=this.getDataUriMimeType(t.src)),this.cropperSettings.minWithRelativeToResolution&&(this.minWidth=this.canvas.width*this.cropperSettings.minWidth/this.srcImage.width,this.minHeight=this.canvas.height*this.cropperSettings.minHeight/this.srcImage.height),this.updateClampBounds(),this.canvasWidth=this.canvas.width,this.canvasHeight=this.canvas.height;var e=this.getCropPositionFromMarkers();this.setCropPosition(e)}else this.imageSet=!1,this.draw(this.ctx)},e.prototype.updateCropPosition=function(t){var e=this.getCropPositionFromBounds(t);this.setCropPosition(e)},e.prototype.setCropPosition=function(t){var e,i;this.tl.setPosition(t[0].x,t[0].y),this.tr.setPosition(t[1].x,t[1].y),this.bl.setPosition(t[2].x,t[2].y),this.br.setPosition(t[3].x,t[3].y),this.center.setPosition(t[4].x,t[4].y);try{for(var o=a(t),r=o.next();!r.done;r=o.next()){var s=r.value;(new d).instance.returnPoint(s)}}catch(t){e={error:t}}finally{try{r&&!r.done&&(i=o.return)&&i.call(o)}finally{if(e)throw e.error}}this.vertSquashRatio=this.detectVerticalSquash(this.srcImage),this.draw(this.ctx),this.croppedImage=this.getCroppedImageHelper(!1,this.cropWidth,this.cropHeight)},e.prototype.getCropPositionFromMarkers=function(){var t,e,i,o,r=this.canvas.width,s=this.canvas.height,n=this.srcImage.height/this.srcImage.width,a=this.getBounds(),h=a.height/a.width,p=this.canvas.width/2,c=this.canvas.height/2;if(h>n){var g=Math.min(r*n,s),u=g/h;t=(new d).instance.borrow(p-u/2,c+g/2),e=(new d).instance.borrow(p+u/2,c+g/2),i=(new d).instance.borrow(p-u/2,c-g/2),o=(new d).instance.borrow(p+u/2,c-g/2)}else{var l=Math.min(s/n,r),f=l*h;t=(new d).instance.borrow(p-l/2,c+f/2),e=(new d).instance.borrow(p+l/2,c+f/2),i=(new d).instance.borrow(p-l/2,c-f/2),o=(new d).instance.borrow(p+l/2,c-f/2)}return[t,e,i,o,(new d).instance.borrow(p,c)]},e.prototype.getCropPositionFromBounds=function(t){var e=0,i=0,o=this.canvasHeight/this.canvasWidth,r=this.srcImage.height/this.srcImage.width;o>r?e=this.buffer.height/2-this.canvasWidth*r/2:i=this.buffer.width/2-this.canvasHeight/r/2;var s=(this.canvasWidth-2*i)/this.srcImage.width,n=(this.canvasHeight-2*e)/this.srcImage.height,a=t.height*n,h=t.width*s,p=t.left*s+i,c=t.top*n+e;if(this.keepAspect){var g=a/this.aspectRatio,u=h*this.aspectRatio;this.getCropBounds().height===t.height?a=u:this.getCropBounds().width===t.width?h=g:Math.abs(u-a)<Math.abs(g-h)?h=g:a=u}return[(new d).instance.borrow(p,c+a),(new d).instance.borrow(p+h,c+a),(new d).instance.borrow(p,c),(new d).instance.borrow(p+h,c),(new d).instance.borrow(p+h/2,c+a/2)]},e.prototype.getCroppedImageHelper=function(t,e,i){return this.cropperSettings.cropOnResize?this.getCroppedImage(t,e,i):this.croppedImage?this.croppedImage:document.createElement("img")},e.prototype.getCroppedImage=function(t,e,i){var o=this.getBounds();if(this.srcImage){var r=this.srcImage.height/this.srcImage.width,s=this.canvas.height/this.canvas.width,n=this.canvas.width,a=this.canvas.height;s>r?(n=this.canvas.width,a=this.canvas.width*r):s<r?(a=this.canvas.height,n=this.canvas.height/r):(a=this.canvas.height,n=this.canvas.width),this.ratioW=n/this.srcImage.width,this.ratioH=a/this.srcImage.height;var h=(this.buffer.height-a)/2/this.ratioH,p=(this.buffer.width-n)/2/this.ratioW,c=this.cropCanvas.getContext("2d");if(this.cropperSettings.preserveSize||t){var g=Math.round(o.right/this.ratioW-o.left/this.ratioW),u=Math.round(o.bottom/this.ratioH-o.top/this.ratioH);this.cropCanvas.width=g,this.cropCanvas.height=u,this.cropperSettings.croppedWidth=this.cropCanvas.width,this.cropperSettings.croppedHeight=this.cropCanvas.height}else this.cropCanvas.width=this.cropWidth,this.cropCanvas.height=this.cropHeight;return c.clearRect(0,0,this.cropCanvas.width,this.cropCanvas.height),this.drawImageIOSFix(c,this.srcImage,Math.max(Math.round(o.left/this.ratioW-p),0),Math.max(Math.round(o.top/this.ratioH-h),0),Math.max(Math.round(o.width/this.ratioW),1),Math.max(Math.round(o.height/this.ratioH),1),0,0,this.cropCanvas.width,this.cropCanvas.height),this.cropperSettings.resampleFn&&this.cropperSettings.resampleFn(this.cropCanvas),this.croppedImage.width=this.cropCanvas.width,this.croppedImage.height=this.cropCanvas.height,this.croppedImage.src=this.cropCanvas.toDataURL(this.fileType,this.cropperSettings.compressRatio),this.croppedImage}return document.createElement("img")},e.prototype.getBounds=function(){var t,e,i=Number.MAX_VALUE,o=Number.MAX_VALUE,r=-Number.MAX_VALUE,s=-Number.MAX_VALUE;try{for(var n=a(this.markers),h=n.next();!h.done;h=n.next()){var p=h.value;p.position.x<i&&(i=p.position.x),p.position.x>r&&(r=p.position.x),p.position.y<o&&(o=p.position.y),p.position.y>s&&(s=p.position.y)}}catch(e){t={error:e}}finally{try{h&&!h.done&&(e=n.return)&&e.call(n)}finally{if(t)throw t.error}}var c=new l;return c.left=i,c.right=r,c.top=o,c.bottom=s,c},e.prototype.setBounds=function(t){var e,i,o=this.getBounds();try{for(var r=a(this.markers),s=r.next();!s.done;s=r.next()){var n=s.value;n.position.x===o.left?n.position.y===o.top?n.setPosition(t.left,t.top):n.setPosition(t.left,t.bottom):n.position.y===o.top?n.setPosition(t.right,t.top):n.setPosition(t.right,t.bottom)}}catch(t){e={error:t}}finally{try{s&&!s.done&&(i=r.return)&&i.call(r)}finally{if(e)throw e.error}}this.center.recalculatePosition(t),this.center.draw(this.ctx),this.draw(this.ctx)},e.prototype.onTouchMove=function(t){if(this.crop.isImageSet()){if(1===t.touches.length){if(this.isMouseDown){t.preventDefault();for(var e=0;e<t.touches.length;e++){var i=t.touches[e],o=this.getTouchPos(this.canvas,i),r=new v(o.x,o.y,i.identifier);(new d).instance.returnPoint(o),this.move(r)}}}else if(2===t.touches.length){t.preventDefault();var s=(t.touches[0].clientX-t.touches[1].clientX)*(t.touches[0].clientX-t.touches[1].clientX)+(t.touches[0].clientY-t.touches[1].clientY)*(t.touches[0].clientY-t.touches[1].clientY);if(this.previousDistance&&this.previousDistance!==s){var n=this.getBounds();s<this.previousDistance&&(n.top+=1,n.left+=1,n.right-=1,n.bottom-=1),s>this.previousDistance&&(n.top!==this.minYClamp&&n.bottom!==this.maxYClamp&&n.left!==this.minXClamp&&n.right!==this.maxXClamp?(n.top-=1,n.left-=1,n.right+=1,n.bottom+=1):n.top!==this.minYClamp&&n.bottom!==this.maxYClamp&&n.left===this.minXClamp&&n.right!==this.maxXClamp?(n.top-=1,n.right+=2,n.bottom+=1):n.top!==this.minYClamp&&n.bottom!==this.maxYClamp&&n.left!==this.minXClamp&&n.right===this.maxXClamp?(n.top-=1,n.left-=2,n.bottom+=1):n.top===this.minYClamp&&n.bottom!==this.maxYClamp&&n.left!==this.minXClamp&&n.right!==this.maxXClamp?(n.left-=1,n.right+=1,n.bottom+=2):n.top!==this.minYClamp&&n.bottom===this.maxYClamp&&n.left!==this.minXClamp&&n.right!==this.maxXClamp?(n.top-=2,n.left-=1,n.right+=1):n.top===this.minYClamp&&n.bottom!==this.maxYClamp&&n.left===this.minXClamp&&n.right!==this.maxXClamp?(n.right+=2,n.bottom+=2):n.top===this.minYClamp&&n.bottom!==this.maxYClamp&&n.left!==this.minXClamp&&n.right===this.maxXClamp?(n.left-=2,n.bottom+=2):n.top!==this.minYClamp&&n.bottom===this.maxYClamp&&n.left===this.minXClamp&&n.right!==this.maxXClamp?(n.top-=2,n.right+=2):n.top!==this.minYClamp&&n.bottom===this.maxYClamp&&n.left!==this.minXClamp&&n.right===this.maxXClamp&&(n.top-=2,n.left-=2)),n.top<this.minYClamp&&(n.top=this.minYClamp),n.bottom>this.maxYClamp&&(n.bottom=this.maxYClamp),n.left<this.minXClamp&&(n.left=this.minXClamp),n.right>this.maxXClamp&&(n.right=this.maxXClamp),this.setBounds(n)}this.previousDistance=s}this.draw(this.ctx)}},e.prototype.onMouseMove=function(t){if(this.crop.isImageSet()&&this.isMouseDown){var e=this.getMousePos(this.canvas,t);this.move(new v(e.x,e.y,0));var i=this.getDragTouchForID(0);i?(i.x=e.x,i.y=e.y):i=new v(e.x,e.y,0),(new d).instance.returnPoint(e),this.drawCursors(i),this.draw(this.ctx)}},e.prototype.move=function(t){this.isMouseDown&&this.handleMove(t)},e.prototype.getDragTouchForID=function(t){for(var e=0;e<this.currentDragTouches.length;e++)if(t===this.currentDragTouches[e].id)return this.currentDragTouches[e]},e.prototype.drawCursors=function(t){var e=!1;null!=t&&(t.dragHandle===this.center&&(this.imageCropperDataShare.setStyle(this.canvas,"move"),e=!0),null!==t.dragHandle&&t.dragHandle instanceof m&&(this.drawCornerCursor(t.dragHandle,t.dragHandle.position.x,t.dragHandle.position.y),e=!0));var i=!1;if(!e){for(var o=0;o<this.markers.length;o++)i=i||this.drawCornerCursor(this.markers[o],t.x,t.y);i||this.imageCropperDataShare.setStyle(this.canvas,"initial")}i||e||!this.center.touchInBounds(t.x,t.y)?this.center.setOver(!1):(this.center.setOver(!0),this.imageCropperDataShare.setOver(this.canvas),this.imageCropperDataShare.setStyle(this.canvas,"move"))},e.prototype.drawCornerCursor=function(t,e,i){return t.touchInBounds(e,i)?(t.setOver(!0),t.getHorizontalNeighbour().position.x>t.position.x?t.getVerticalNeighbour().position.y>t.position.y?(this.imageCropperDataShare.setOver(this.canvas),this.imageCropperDataShare.setStyle(this.canvas,"nwse-resize")):(this.imageCropperDataShare.setOver(this.canvas),this.imageCropperDataShare.setStyle(this.canvas,"nesw-resize")):t.getVerticalNeighbour().position.y>t.position.y?(this.imageCropperDataShare.setOver(this.canvas),this.imageCropperDataShare.setStyle(this.canvas,"nesw-resize")):(this.imageCropperDataShare.setOver(this.canvas),this.imageCropperDataShare.setStyle(this.canvas,"nwse-resize")),!0):(t.setOver(!1),!1)},e.prototype.onTouchStart=function(t){var e,i;if(this.crop.isImageSet()){var o=t.touches[0],r=this.getTouchPos(this.canvas,o),s=new v(r.x,r.y,o.identifier);(new d).instance.returnPoint(r),this.isMouseDown=!1;try{for(var n=a(this.markers),h=n.next();!h.done;h=n.next()){h.value.touchInBounds(s.x,s.y)&&(this.isMouseDown=!0)}}catch(t){e={error:t}}finally{try{h&&!h.done&&(i=n.return)&&i.call(n)}finally{if(e)throw e.error}}this.center.touchInBounds(s.x,s.y)&&(this.isMouseDown=!0)}},e.prototype.onTouchEnd=function(t){if(this.crop.isImageSet()){for(var e=0;e<t.changedTouches.length;e++){var i=t.changedTouches[e],o=this.getDragTouchForID(i.identifier);o&&void 0!==o&&((o.dragHandle instanceof m||o.dragHandle instanceof y)&&o.dragHandle.setOver(!1),this.handleRelease(o))}0===this.currentDragTouches.length&&(this.isMouseDown=!1,this.currentlyInteracting=!1)}},e.prototype.drawImageIOSFix=function(t,e,i,o,r,s,n,a,h,p){t.drawImage(e,i,o,r,s,n,a,h,p)},e.prototype.onMouseDown=function(t){this.crop.isImageSet()&&(this.isMouseDown=!0)},e.prototype.onMouseUp=function(t){this.crop.isImageSet()&&(this.imageCropperDataShare.setReleased(this.canvas),this.isMouseDown=!1,this.handleRelease(new v(0,0,0)))},e}(w),S=function(){function t(t,e,i,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===o&&(o=0),this.x=+t,this.y=+e,this.w=+i,this.h=+o}return t.prototype.toBounds=function(){return new l(this.x,this.y,this.w,this.h)},t.prototype.isInitialized=function(){return 0!==this.x&&0!==this.y&&0!==this.w&&0!==this.h},t}(),x=function(){function t(t,i){this.document=i,this.cropPositionChange=new e.EventEmitter,this.exif=new g,this.onCrop=new e.EventEmitter,this.imageSet=new e.EventEmitter,this.dragUnsubscribers=[],this.renderer=t}var o,r;return t.prototype.ngAfterViewInit=function(){var t=this.cropcanvas.nativeElement;this.settings||(this.settings=new p),this.settings.cropperClass&&this.renderer.setAttribute(t,"class",this.settings.cropperClass),this.settings.dynamicSizing?(this.windowListener=this.resize.bind(this),window.addEventListener("resize",this.windowListener)):(this.renderer.setAttribute(t,"width",this.settings.canvasWidth.toString()),this.renderer.setAttribute(t,"height",this.settings.canvasHeight.toString())),this.cropper||(this.cropper=new b(this.settings)),this.cropper.prepare(t)},t.prototype.ngOnChanges=function(t){if(this.isCropPositionChanged(t)){if(this.cropper.updateCropPosition(this.cropPosition.toBounds()),this.cropper.isImageSet()){var e=this.cropper.getCropBounds();this.image.image=this.cropper.getCroppedImageHelper().src,this.onCrop.emit(e)}this.updateCropBounds()}t.inputImage&&this.setImage(t.inputImage.currentValue),t.settings&&this.cropper&&(this.cropper.updateSettings(this.settings),this.cropper.isImageSet()&&(this.image.image=this.cropper.getCroppedImageHelper().src,this.onCrop.emit(this.cropper.getCropBounds())))},t.prototype.ngOnDestroy=function(){this.removeDragListeners(),this.settings.dynamicSizing&&this.windowListener&&window.removeEventListener("resize",this.windowListener)},t.prototype.onTouchMove=function(t){this.cropper.onTouchMove(t)},t.prototype.onTouchStart=function(t){this.cropper.onTouchStart(t)},t.prototype.onTouchEnd=function(t){this.cropper.onTouchEnd(t),this.cropper.isImageSet()&&(this.image.image=this.cropper.getCroppedImageHelper().src,this.onCrop.emit(this.cropper.getCropBounds()),this.updateCropBounds())},t.prototype.onMouseDown=function(t){this.dragUnsubscribers.push(this.renderer.listen(this.document,"mousemove",this.onMouseMove.bind(this))),this.dragUnsubscribers.push(this.renderer.listen(this.document,"mouseup",this.onMouseUp.bind(this))),this.cropper.onMouseDown(t)},t.prototype.removeDragListeners=function(){this.dragUnsubscribers.forEach((function(t){return t()}))},t.prototype.onMouseUp=function(t){this.removeDragListeners(),this.cropper.isImageSet()&&(this.cropper.onMouseUp(t),this.image.image=this.cropper.getCroppedImageHelper().src,this.onCrop.emit(this.cropper.getCropBounds()),this.updateCropBounds())},t.prototype.onMouseMove=function(t){this.cropper.onMouseMove(t)},t.prototype.fileChangeListener=function(t){var e=this;if(0!==t.target.files.length){var i=t.target.files[0];if(this.settings.allowedFilesRegex.test(i.name)){var o=new Image,r=new FileReader;r.addEventListener("loadend",(function(t){o.addEventListener("load",(function(){e.setImage(o)})),o.src=t.target.result})),r.readAsDataURL(i)}}},t.prototype.resize=function(){var t=this.cropcanvas.nativeElement;this.settings.canvasWidth=t.offsetWidth,this.settings.canvasHeight=t.offsetHeight,this.cropper.resizeCanvas(t.offsetWidth,t.offsetHeight,!0)},t.prototype.reset=function(){this.cropper.reset(),this.renderer.setAttribute(this.cropcanvas.nativeElement,"class",this.settings.cropperClass),this.image.image=this.cropper.getCroppedImageHelper().src},t.prototype.setImage=function(t,e){var i=this;void 0===e&&(e=null),this.imageSet.emit(!0),this.renderer.setAttribute(this.cropcanvas.nativeElement,"class",this.settings.cropperClass+" "+this.settings.croppingClass),this.raf=window.requestAnimationFrame((function(){i.raf&&window.cancelAnimationFrame(i.raf),t.naturalHeight>0&&t.naturalWidth>0&&(t.height=t.naturalHeight,t.width=t.naturalWidth,window.cancelAnimationFrame(i.raf),i.getOrientedImage(t,(function(o){if(i.settings.dynamicSizing){var r=i.cropcanvas.nativeElement;i.settings.canvasWidth=r.offsetWidth,i.settings.canvasHeight=r.offsetHeight,i.cropper.resizeCanvas(r.offsetWidth,r.offsetHeight,!1)}i.cropper.setImage(o),i.cropPosition&&i.cropPosition.isInitialized()&&i.cropper.updateCropPosition(i.cropPosition.toBounds()),i.image.original=o;var s=i.cropper.getCropBounds();i.image.image=i.cropper.getCroppedImageHelper().src,i.image||(i.image=t),null!=e&&(s=e,i.cropper.setBounds(s),i.cropper.updateCropPosition(s)),i.onCrop.emit(s)})))}))},t.prototype.isCropPositionChanged=function(t){return!!(this.cropper&&t.cropPosition&&this.isCropPositionUpdateNeeded)||(this.isCropPositionUpdateNeeded=!0,!1)},t.prototype.updateCropBounds=function(){var t=this.cropper.getCropBounds();this.cropPositionChange.emit(new S(t.left,t.top,t.width,t.height)),this.isCropPositionUpdateNeeded=!1},t.prototype.getOrientedImage=function(t,e){var i,o=this;this.exif.getData(t,(function(){var r=o.exif.getTag(t,"Orientation");if([3,6,8].indexOf(r)>-1){var s=document.createElement("canvas"),n=s.getContext("2d"),a=t.width,h=t.height,p=0,c=0,g=0;switch(r){case 3:p=-t.width,c=-t.height,g=180;break;case 6:a=t.height,h=t.width,c=-t.height,g=90;break;case 8:a=t.height,h=t.width,p=-t.width,g=270}s.width=a,s.height=h,n.rotate(g*Math.PI/180),n.drawImage(t,p,c),(i=document.createElement("img")).width=a,i.height=h,i.addEventListener("load",(function(){e(i)})),i.src=s.toDataURL("image/png")}else e(i=t)}))},t.ctorParameters=function(){return[{type:e.Renderer2},{type:void 0,decorators:[{type:e.Inject,args:[i.DOCUMENT]}]}]},s([e.ViewChild("cropcanvas",{static:!0}),n("design:type",e.ElementRef)],t.prototype,"cropcanvas",void 0),s([e.ViewChild("fileInput"),n("design:type",e.ElementRef)],t.prototype,"fileInput",void 0),s([e.Input(),n("design:type",p)],t.prototype,"settings",void 0),s([e.Input(),n("design:type",Object)],t.prototype,"image",void 0),s([e.Input(),n("design:type",Object)],t.prototype,"inputImage",void 0),s([e.Input(),n("design:type",b)],t.prototype,"cropper",void 0),s([e.Input(),n("design:type",S)],t.prototype,"cropPosition",void 0),s([e.Output(),n("design:type",e.EventEmitter)],t.prototype,"cropPositionChange",void 0),s([e.Output(),n("design:type",e.EventEmitter)],t.prototype,"onCrop",void 0),s([e.Output(),n("design:type",e.EventEmitter)],t.prototype,"imageSet",void 0),t=s([e.Component({selector:"img-cropper",template:'<span class="ng2-imgcrop">\r\n  <input\r\n    *ngIf="!settings.noFileInput"\r\n    #fileInput\r\n    type="file"\r\n    accept="image/*"\r\n    (change)="fileChangeListener($event)"\r\n  />\r\n  <canvas\r\n    #cropcanvas\r\n    (mousedown)="onMouseDown($event)"\r\n    (touchmove)="onTouchMove($event)"\r\n    (touchend)="onTouchEnd($event)"\r\n    (touchstart)="onTouchStart($event)"\r\n  >\r\n  </canvas>\r\n</span>\r\n'}),(o=1,r=e.Inject(i.DOCUMENT),function(t,e){r(t,e,o)}),n("design:paramtypes",[e.Renderer2,Object])],t)}(),I=function(){function t(){}return t=s([e.NgModule({declarations:[x],exports:[x],imports:[i.CommonModule]})],t)}(),P=function(){function t(){}return t.ɵprov=e.ɵɵdefineInjectable({factory:function(){return new t},token:t,providedIn:"root"}),t=s([e.Injectable({providedIn:"root"}),n("design:paramtypes",[])],t)}(),D=function(){function t(){}return t.prototype.init=function(t){this.canvas=t,this.ctx=this.canvas.getContext("2d")},t}();t.Bounds=l,t.CornerMarker=m,t.CropPosition=S,t.CropService=D,t.CropTouch=v,t.CropperDrawSettings=h,t.CropperSettings=p,t.DragMarker=y,t.Exif=g,t.Fraction=c,t.Handle=f,t.ImageCropper=b,t.ImageCropperComponent=x,t.ImageCropperDataShare=C,t.ImageCropperModel=w,t.ImageCropperModule=I,t.ImageCropperService=P,t.Point=u,t.PointPool=d,t.ɵa=w,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=ngx-img-cropper.umd.min.js.map