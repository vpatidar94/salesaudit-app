import { __decorate, __metadata, __param } from "tslib";
import { Component, AfterViewInit, OnChanges, OnDestroy, ViewChild, ElementRef, Input, Output, EventEmitter, Renderer2, SimpleChanges, Inject } from '@angular/core';
import { CropperSettings } from './cropper-settings';
import { ImageCropper } from './imageCropper';
import { CropPosition } from './model/cropPosition';
import { Exif } from './exif';
import { DOCUMENT } from '@angular/common';
let ImageCropperComponent = class ImageCropperComponent {
    constructor(renderer, document) {
        this.document = document;
        this.cropPositionChange = new EventEmitter();
        this.exif = new Exif();
        // tslint:disable-next-line:no-output-on-prefix
        this.onCrop = new EventEmitter();
        this.imageSet = new EventEmitter();
        this.dragUnsubscribers = [];
        this.renderer = renderer;
    }
    ngAfterViewInit() {
        const canvas = this.cropcanvas.nativeElement;
        if (!this.settings) {
            this.settings = new CropperSettings();
        }
        if (this.settings.cropperClass) {
            this.renderer.setAttribute(canvas, 'class', this.settings.cropperClass);
        }
        if (!this.settings.dynamicSizing) {
            this.renderer.setAttribute(canvas, 'width', this.settings.canvasWidth.toString());
            this.renderer.setAttribute(canvas, 'height', this.settings.canvasHeight.toString());
        }
        else {
            this.windowListener = this.resize.bind(this);
            window.addEventListener('resize', this.windowListener);
        }
        if (!this.cropper) {
            this.cropper = new ImageCropper(this.settings);
        }
        this.cropper.prepare(canvas);
    }
    ngOnChanges(changes) {
        if (this.isCropPositionChanged(changes)) {
            this.cropper.updateCropPosition(this.cropPosition.toBounds());
            if (this.cropper.isImageSet()) {
                const bounds = this.cropper.getCropBounds();
                this.image.image = this.cropper.getCroppedImageHelper().src;
                this.onCrop.emit(bounds);
            }
            this.updateCropBounds();
        }
        if (changes.inputImage) {
            this.setImage(changes.inputImage.currentValue);
        }
        if (changes.settings && this.cropper) {
            this.cropper.updateSettings(this.settings);
            if (this.cropper.isImageSet()) {
                this.image.image = this.cropper.getCroppedImageHelper().src;
                this.onCrop.emit(this.cropper.getCropBounds());
            }
        }
    }
    ngOnDestroy() {
        this.removeDragListeners();
        if (this.settings.dynamicSizing && this.windowListener) {
            window.removeEventListener('resize', this.windowListener);
        }
    }
    onTouchMove(event) {
        this.cropper.onTouchMove(event);
    }
    onTouchStart(event) {
        this.cropper.onTouchStart(event);
    }
    onTouchEnd(event) {
        this.cropper.onTouchEnd(event);
        if (this.cropper.isImageSet()) {
            this.image.image = this.cropper.getCroppedImageHelper().src;
            this.onCrop.emit(this.cropper.getCropBounds());
            this.updateCropBounds();
        }
    }
    onMouseDown(event) {
        this.dragUnsubscribers.push(this.renderer.listen(this.document, 'mousemove', this.onMouseMove.bind(this)));
        this.dragUnsubscribers.push(this.renderer.listen(this.document, 'mouseup', this.onMouseUp.bind(this)));
        this.cropper.onMouseDown(event);
        // if (!this.cropper.isImageSet() && !this.settings.noFileInput) {
        //   // load img
        //   this.fileInput.nativeElement.click();
        // }
    }
    removeDragListeners() {
        this.dragUnsubscribers.forEach(unsubscribe => unsubscribe());
    }
    onMouseUp(event) {
        this.removeDragListeners();
        if (this.cropper.isImageSet()) {
            this.cropper.onMouseUp(event);
            this.image.image = this.cropper.getCroppedImageHelper().src;
            this.onCrop.emit(this.cropper.getCropBounds());
            this.updateCropBounds();
        }
    }
    onMouseMove(event) {
        this.cropper.onMouseMove(event);
    }
    fileChangeListener($event) {
        if ($event.target.files.length === 0) {
            return;
        }
        const file = $event.target.files[0];
        if (this.settings.allowedFilesRegex.test(file.name)) {
            const image = new Image();
            const fileReader = new FileReader();
            fileReader.addEventListener('loadend', (loadEvent) => {
                image.addEventListener('load', () => {
                    this.setImage(image);
                });
                image.src = loadEvent.target.result;
            });
            fileReader.readAsDataURL(file);
        }
    }
    resize() {
        const canvas = this.cropcanvas.nativeElement;
        this.settings.canvasWidth = canvas.offsetWidth;
        this.settings.canvasHeight = canvas.offsetHeight;
        this.cropper.resizeCanvas(canvas.offsetWidth, canvas.offsetHeight, true);
    }
    reset() {
        this.cropper.reset();
        this.renderer.setAttribute(this.cropcanvas.nativeElement, 'class', this.settings.cropperClass);
        this.image.image = this.cropper.getCroppedImageHelper().src;
    }
    setImage(image, newBounds = null) {
        this.imageSet.emit(true);
        this.renderer.setAttribute(this.cropcanvas.nativeElement, 'class', `${this.settings.cropperClass} ${this.settings.croppingClass}`);
        this.raf = window.requestAnimationFrame(() => {
            if (this.raf) {
                window.cancelAnimationFrame(this.raf);
            }
            if (image.naturalHeight > 0 && image.naturalWidth > 0) {
                image.height = image.naturalHeight;
                image.width = image.naturalWidth;
                window.cancelAnimationFrame(this.raf);
                this.getOrientedImage(image, (img) => {
                    if (this.settings.dynamicSizing) {
                        const canvas = this.cropcanvas.nativeElement;
                        this.settings.canvasWidth = canvas.offsetWidth;
                        this.settings.canvasHeight = canvas.offsetHeight;
                        this.cropper.resizeCanvas(canvas.offsetWidth, canvas.offsetHeight, false);
                    }
                    this.cropper.setImage(img);
                    if (this.cropPosition && this.cropPosition.isInitialized()) {
                        this.cropper.updateCropPosition(this.cropPosition.toBounds());
                    }
                    this.image.original = img;
                    let bounds = this.cropper.getCropBounds();
                    this.image.image = this.cropper.getCroppedImageHelper().src;
                    if (!this.image) {
                        this.image = image;
                    }
                    if (newBounds != null) {
                        bounds = newBounds;
                        this.cropper.setBounds(bounds);
                        this.cropper.updateCropPosition(bounds);
                    }
                    this.onCrop.emit(bounds);
                });
            }
        });
    }
    isCropPositionChanged(changes) {
        if (this.cropper &&
            changes.cropPosition &&
            this.isCropPositionUpdateNeeded) {
            return true;
        }
        else {
            this.isCropPositionUpdateNeeded = true;
            return false;
        }
    }
    updateCropBounds() {
        const cropBound = this.cropper.getCropBounds();
        this.cropPositionChange.emit(new CropPosition(cropBound.left, cropBound.top, cropBound.width, cropBound.height));
        this.isCropPositionUpdateNeeded = false;
    }
    getOrientedImage(image, callback) {
        let img;
        this.exif.getData(image, () => {
            const orientation = this.exif.getTag(image, 'Orientation');
            if ([3, 6, 8].indexOf(orientation) > -1) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                let cw = image.width;
                let ch = image.height;
                let cx = 0;
                let cy = 0;
                let deg = 0;
                switch (orientation) {
                    case 3:
                        cx = -image.width;
                        cy = -image.height;
                        deg = 180;
                        break;
                    case 6:
                        cw = image.height;
                        ch = image.width;
                        cy = -image.height;
                        deg = 90;
                        break;
                    case 8:
                        cw = image.height;
                        ch = image.width;
                        cx = -image.width;
                        deg = 270;
                        break;
                    default:
                        break;
                }
                canvas.width = cw;
                canvas.height = ch;
                ctx.rotate((deg * Math.PI) / 180);
                ctx.drawImage(image, cx, cy);
                img = document.createElement('img');
                img.width = cw;
                img.height = ch;
                img.addEventListener('load', () => {
                    callback(img);
                });
                img.src = canvas.toDataURL('image/png');
            }
            else {
                img = image;
                callback(img);
            }
        });
    }
};
ImageCropperComponent.ctorParameters = () => [
    { type: Renderer2 },
    { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] }
];
__decorate([
    ViewChild('cropcanvas', { static: true }),
    __metadata("design:type", ElementRef)
], ImageCropperComponent.prototype, "cropcanvas", void 0);
__decorate([
    ViewChild('fileInput'),
    __metadata("design:type", ElementRef)
], ImageCropperComponent.prototype, "fileInput", void 0);
__decorate([
    Input(),
    __metadata("design:type", CropperSettings)
], ImageCropperComponent.prototype, "settings", void 0);
__decorate([
    Input(),
    __metadata("design:type", Object)
], ImageCropperComponent.prototype, "image", void 0);
__decorate([
    Input(),
    __metadata("design:type", Object)
], ImageCropperComponent.prototype, "inputImage", void 0);
__decorate([
    Input(),
    __metadata("design:type", ImageCropper)
], ImageCropperComponent.prototype, "cropper", void 0);
__decorate([
    Input(),
    __metadata("design:type", CropPosition)
], ImageCropperComponent.prototype, "cropPosition", void 0);
__decorate([
    Output(),
    __metadata("design:type", EventEmitter)
], ImageCropperComponent.prototype, "cropPositionChange", void 0);
__decorate([
    Output(),
    __metadata("design:type", EventEmitter)
], ImageCropperComponent.prototype, "onCrop", void 0);
__decorate([
    Output(),
    __metadata("design:type", EventEmitter)
], ImageCropperComponent.prototype, "imageSet", void 0);
ImageCropperComponent = __decorate([
    Component({
        // tslint:disable-next-line:component-selector
        selector: 'img-cropper',
        template: "<span class=\"ng2-imgcrop\">\r\n  <input\r\n    *ngIf=\"!settings.noFileInput\"\r\n    #fileInput\r\n    type=\"file\"\r\n    accept=\"image/*\"\r\n    (change)=\"fileChangeListener($event)\"\r\n  />\r\n  <canvas\r\n    #cropcanvas\r\n    (mousedown)=\"onMouseDown($event)\"\r\n    (touchmove)=\"onTouchMove($event)\"\r\n    (touchend)=\"onTouchEnd($event)\"\r\n    (touchstart)=\"onTouchStart($event)\"\r\n  >\r\n  </canvas>\r\n</span>\r\n"
    }),
    __param(1, Inject(DOCUMENT)),
    __metadata("design:paramtypes", [Renderer2, Object])
], ImageCropperComponent);
export { ImageCropperComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1hZ2UtY3JvcHBlci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZ3gtaW1nLWNyb3BwZXIvIiwic291cmNlcyI6WyJsaWIvaW1hZ2UtY3JvcHBlci9pbWFnZS1jcm9wcGVyLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLFNBQVMsRUFDVCxhQUFhLEVBQ2IsU0FBUyxFQUNULFNBQVMsRUFDVCxTQUFTLEVBQ1QsVUFBVSxFQUNWLEtBQUssRUFDTCxNQUFNLEVBQ04sWUFBWSxFQUNaLFNBQVMsRUFDVCxhQUFhLEVBQUUsTUFBTSxFQUN0QixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDckQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUVwRCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBQzlCLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQU8zQyxJQUFhLHFCQUFxQixHQUFsQyxNQUFhLHFCQUFxQjtJQWdDaEMsWUFBWSxRQUFtQixFQUNPLFFBQVE7UUFBUixhQUFRLEdBQVIsUUFBUSxDQUFBO1FBckJ2Qyx1QkFBa0IsR0FBK0IsSUFBSSxZQUFZLEVBRXJFLENBQUM7UUFFSSxTQUFJLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUUxQiwrQ0FBK0M7UUFDOUIsV0FBTSxHQUFzQixJQUFJLFlBQVksRUFBRSxDQUFDO1FBQ3RELGFBQVEsR0FBMEIsSUFBSSxZQUFZLEVBQVcsQ0FBQztRQVVoRSxzQkFBaUIsR0FBbUIsRUFBRSxDQUFDO1FBSTdDLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO0lBQzNCLENBQUM7SUFFTSxlQUFlO1FBQ3BCLE1BQU0sTUFBTSxHQUFzQixJQUFJLENB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UztHQWhDcEIscUJBQXFCLENBbVVqQztTQW5VWSxxQkFBcUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIENvbXBvbmVudCxcclxuICBBZnRlclZpZXdJbml0LFxyXG4gIE9uQ2hhbmdlcyxcclxuICBPbkRlc3Ryb3ksXHJcbiAgVmlld0NoaWxkLFxyXG4gIEVsZW1lbnRSZWYsXHJcbiAgSW5wdXQsXHJcbiAgT3V0cHV0LFxyXG4gIEV2ZW50RW1pdHRlcixcclxuICBSZW5kZXJlcjIsXHJcbiAgU2ltcGxlQ2hhbmdlcywgSW5qZWN0XHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IENyb3BwZXJTZXR0aW5ncyB9IGZyb20gJy4vY3JvcHBlci1zZXR0aW5ncyc7XHJcbmltcG9ydCB7IEltYWdlQ3JvcHBlciB9IGZyb20gJy4vaW1hZ2VDcm9wcGVyJztcclxuaW1wb3J0IHsgQ3JvcFBvc2l0aW9uIH0gZnJvbSAnLi9tb2RlbC9jcm9wUG9zaXRpb24nO1xyXG5pbXBvcnQgeyBCb3VuZHMgfSBmcm9tICcuL21vZGVsL2JvdW5kcyc7XHJcbmltcG9ydCB7IEV4aWYgfSBmcm9tICcuL2V4aWYnO1xyXG5pbXBvcnQgeyBET0NVTUVOVCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6Y29tcG9uZW50LXNlbGVjdG9yXHJcbiAgc2VsZWN0b3I6ICdpbWctY3JvcHBlcicsXHJcbiAgdGVtcGxhdGVVcmw6ICcuL2ltYWdlLWNyb3BwZXIuY29tcG9uZW50Lmh0bWwnXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBJbWFnZUNyb3BwZXJDb21wb25lbnRcclxuICBpbXBsZW1lbnRzIEFmdGVyVmlld0luaXQsIE9uQ2hhbmdlcywgT25EZXN0cm95IHtcclxuICBAVmlld0NoaWxkKCdjcm9wY2FudmFzJywgeyBzdGF0aWM6IHRydWUgfSlcclxuICBjcm9wY2FudmFzOiBFbGVtZW50UmVmO1xyXG4gIEBWaWV3Q2hpbGQoJ2ZpbGVJbnB1dCcpIGZpbGVJbnB1dDogRWxlbWVudFJlZjtcclxuXHJcbiAgQElucHV0KCkgcHVibGljIHNldHRpbmdzOiBDcm9wcGVyU2V0dGluZ3M7XHJcbiAgQElucHV0KCkgcHVibGljIGltYWdlOiBhbnk7XHJcbiAgQElucHV0KCkgcHVibGljIGlucHV0SW1hZ2U6IGFueTtcclxuICBASW5wdXQoKSBwdWJsaWMgY3JvcHBlcjogSW1hZ2VDcm9wcGVyO1xyXG4gIEBJbnB1dCgpIHB1YmxpYyBjcm9wUG9zaXRpb246IENyb3BQb3NpdGlvbjtcclxuICBAT3V0cHV0KClcclxuICBwdWJsaWMgY3JvcFBvc2l0aW9uQ2hhbmdlOiBFdmVudEVtaXR0ZXI8Q3JvcFBvc2l0aW9uPiA9IG5ldyBFdmVudEVtaXR0ZXI8XHJcbiAgICBDcm9wUG9zaXRpb25cclxuICA+KCk7XHJcblxyXG4gIHByaXZhdGUgZXhpZiA9IG5ldyBFeGlmKCk7XHJcblxyXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1vdXRwdXQtb24tcHJlZml4XHJcbiAgQE91dHB1dCgpIHB1YmxpYyBvbkNyb3A6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xyXG4gIEBPdXRwdXQoKSBpbWFnZVNldDogRXZlbnRFbWl0dGVyPGJvb2xlYW4+ID0gbmV3IEV2ZW50RW1pdHRlcjxib29sZWFuPigpO1xyXG5cclxuICBwdWJsaWMgY3JvcHBlZFdpZHRoOiBudW1iZXI7XHJcbiAgcHVibGljIGNyb3BwZWRIZWlnaHQ6IG51bWJlcjtcclxuICBwdWJsaWMgaW50ZXJ2YWxSZWY6IG51bWJlcjtcclxuICBwdWJsaWMgcmFmOiBudW1iZXI7XHJcbiAgcHVibGljIHJlbmRlcmVyOiBSZW5kZXJlcjI7XHJcbiAgcHVibGljIHdpbmRvd0xpc3RlbmVyOiBFdmVudExpc3RlbmVyT2JqZWN0O1xyXG5cclxuICBwcml2YXRlIGlzQ3JvcFBvc2l0aW9uVXBkYXRlTmVlZGVkOiBib29sZWFuO1xyXG4gIHByaXZhdGUgZHJhZ1Vuc3Vic2NyaWJlcnM6ICgoKSA9PiB2b2lkKVtdID0gW107XHJcblxyXG4gIGNvbnN0cnVjdG9yKHJlbmRlcmVyOiBSZW5kZXJlcjIsXHJcbiAgICAgICAgICAgICAgQEluamVjdChET0NVTUVOVCkgcHJpdmF0ZSBkb2N1bWVudCkge1xyXG4gICAgdGhpcy5yZW5kZXJlciA9IHJlbmRlcmVyO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIG5nQWZ0ZXJWaWV3SW5pdCgpOiB2b2lkIHtcclxuICAgIGNvbnN0IGNhbnZhczogSFRNTENhbnZhc0VsZW1lbnQgPSB0aGlzLmNyb3BjYW52YXMubmF0aXZlRWxlbWVudDtcclxuXHJcbiAgICBpZiAoIXRoaXMuc2V0dGluZ3MpIHtcclxuICAgICAgdGhpcy5zZXR0aW5ncyA9IG5ldyBDcm9wcGVyU2V0dGluZ3MoKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodGhpcy5zZXR0aW5ncy5jcm9wcGVyQ2xhc3MpIHtcclxuICAgICAgdGhpcy5yZW5kZXJlci5zZXRBdHRyaWJ1dGUoY2FudmFzLCAnY2xhc3MnLCB0aGlzLnNldHRpbmdzLmNyb3BwZXJDbGFzcyk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCF0aGlzLnNldHRpbmdzLmR5bmFtaWNTaXppbmcpIHtcclxuICAgICAgdGhpcy5yZW5kZXJlci5zZXRBdHRyaWJ1dGUoXHJcbiAgICAgICAgY2FudmFzLFxyXG4gICAgICAgICd3aWR0aCcsXHJcbiAgICAgICAgdGhpcy5zZXR0aW5ncy5jYW52YXNXaWR0aC50b1N0cmluZygpXHJcbiAgICAgICk7XHJcbiAgICAgIHRoaXMucmVuZGVyZXIuc2V0QXR0cmlidXRlKFxyXG4gICAgICAgIGNhbnZhcyxcclxuICAgICAgICAnaGVpZ2h0JyxcclxuICAgICAgICB0aGlzLnNldHRpbmdzLmNhbnZhc0hlaWdodC50b1N0cmluZygpXHJcbiAgICAgICk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLndpbmRvd0xpc3RlbmVyID0gdGhpcy5yZXNpemUuYmluZCh0aGlzKTtcclxuICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIHRoaXMud2luZG93TGlzdGVuZXIpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICghdGhpcy5jcm9wcGVyKSB7XHJcbiAgICAgIHRoaXMuY3JvcHBlciA9IG5ldyBJbWFnZUNyb3BwZXIodGhpcy5zZXR0aW5ncyk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5jcm9wcGVyLnByZXBhcmUoY2FudmFzKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XHJcbiAgICBpZiAodGhpcy5pc0Nyb3BQb3NpdGlvbkNoYW5nZWQoY2hhbmdlcykpIHtcclxuICAgICAgdGhpcy5jcm9wcGVyLnVwZGF0ZUNyb3BQb3NpdGlvbih0aGlzLmNyb3BQb3NpdGlvbi50b0JvdW5kcygpKTtcclxuICAgICAgaWYgKHRoaXMuY3JvcHBlci5pc0ltYWdlU2V0KCkpIHtcclxuICAgICAgICBjb25zdCBib3VuZHMgPSB0aGlzLmNyb3BwZXIuZ2V0Q3JvcEJvdW5kcygpO1xyXG4gICAgICAgIHRoaXMuaW1hZ2UuaW1hZ2UgPSB0aGlzLmNyb3BwZXIuZ2V0Q3JvcHBlZEltYWdlSGVscGVyKCkuc3JjO1xyXG4gICAgICAgIHRoaXMub25Dcm9wLmVtaXQoYm91bmRzKTtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLnVwZGF0ZUNyb3BCb3VuZHMoKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoY2hhbmdlcy5pbnB1dEltYWdlKSB7XHJcbiAgICAgIHRoaXMuc2V0SW1hZ2UoY2hhbmdlcy5pbnB1dEltYWdlLmN1cnJlbnRWYWx1ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGNoYW5nZXMuc2V0dGluZ3MgJiYgdGhpcy5jcm9wcGVyKSB7XHJcbiAgICAgIHRoaXMuY3JvcHBlci51cGRhdGVTZXR0aW5ncyh0aGlzLnNldHRpbmdzKTtcclxuICAgICAgaWYgKHRoaXMuY3JvcHBlci5pc0ltYWdlU2V0KCkpIHtcclxuICAgICAgICB0aGlzLmltYWdlLmltYWdlID0gdGhpcy5jcm9wcGVyLmdldENyb3BwZWRJbWFnZUhlbHBlcigpLnNyYztcclxuICAgICAgICB0aGlzLm9uQ3JvcC5lbWl0KHRoaXMuY3JvcHBlci5nZXRDcm9wQm91bmRzKCkpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgbmdPbkRlc3Ryb3koKSB7XHJcbiAgICB0aGlzLnJlbW92ZURyYWdMaXN0ZW5lcnMoKTtcclxuICAgIGlmICh0aGlzLnNldHRpbmdzLmR5bmFtaWNTaXppbmcgJiYgdGhpcy53aW5kb3dMaXN0ZW5lcikge1xyXG4gICAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigncmVzaXplJywgdGhpcy53aW5kb3dMaXN0ZW5lcik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgb25Ub3VjaE1vdmUoZXZlbnQ6IFRvdWNoRXZlbnQpOiB2b2lkIHtcclxuICAgIHRoaXMuY3JvcHBlci5vblRvdWNoTW92ZShldmVudCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgb25Ub3VjaFN0YXJ0KGV2ZW50OiBUb3VjaEV2ZW50KTogdm9pZCB7XHJcbiAgICB0aGlzLmNyb3BwZXIub25Ub3VjaFN0YXJ0KGV2ZW50KTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBvblRvdWNoRW5kKGV2ZW50OiBUb3VjaEV2ZW50KTogdm9pZCB7XHJcbiAgICB0aGlzLmNyb3BwZXIub25Ub3VjaEVuZChldmVudCk7XHJcbiAgICBpZiAodGhpcy5jcm9wcGVyLmlzSW1hZ2VTZXQoKSkge1xyXG4gICAgICB0aGlzLmltYWdlLmltYWdlID0gdGhpcy5jcm9wcGVyLmdldENyb3BwZWRJbWFnZUhlbHBlcigpLnNyYztcclxuICAgICAgdGhpcy5vbkNyb3AuZW1pdCh0aGlzLmNyb3BwZXIuZ2V0Q3JvcEJvdW5kcygpKTtcclxuICAgICAgdGhpcy51cGRhdGVDcm9wQm91bmRzKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgb25Nb3VzZURvd24oZXZlbnQ6IE1vdXNlRXZlbnQpOiB2b2lkIHtcclxuICAgIHRoaXMuZHJhZ1Vuc3Vic2NyaWJlcnMucHVzaCh0aGlzLnJlbmRlcmVyLmxpc3Rlbih0aGlzLmRvY3VtZW50LCAnbW91c2Vtb3ZlJywgdGhpcy5vbk1vdXNlTW92ZS5iaW5kKHRoaXMpKSk7XHJcbiAgICB0aGlzLmRyYWdVbnN1YnNjcmliZXJzLnB1c2godGhpcy5yZW5kZXJlci5saXN0ZW4odGhpcy5kb2N1bWVudCwgJ21vdXNldXAnLCB0aGlzLm9uTW91c2VVcC5iaW5kKHRoaXMpKSk7XHJcblxyXG4gICAgdGhpcy5jcm9wcGVyLm9uTW91c2VEb3duKGV2ZW50KTtcclxuICAgIC8vIGlmICghdGhpcy5jcm9wcGVyLmlzSW1hZ2VTZXQoKSAmJiAhdGhpcy5zZXR0aW5ncy5ub0ZpbGVJbnB1dCkge1xyXG4gICAgLy8gICAvLyBsb2FkIGltZ1xyXG4gICAgLy8gICB0aGlzLmZpbGVJbnB1dC5uYXRpdmVFbGVtZW50LmNsaWNrKCk7XHJcbiAgICAvLyB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJlbW92ZURyYWdMaXN0ZW5lcnMoKSB7XHJcbiAgICB0aGlzLmRyYWdVbnN1YnNjcmliZXJzLmZvckVhY2godW5zdWJzY3JpYmUgPT4gdW5zdWJzY3JpYmUoKSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgb25Nb3VzZVVwKGV2ZW50OiBNb3VzZUV2ZW50KTogdm9pZCB7XHJcbiAgICB0aGlzLnJlbW92ZURyYWdMaXN0ZW5lcnMoKTtcclxuICAgIGlmICh0aGlzLmNyb3BwZXIuaXNJbWFnZVNldCgpKSB7XHJcbiAgICAgIHRoaXMuY3JvcHBlci5vbk1vdXNlVXAoZXZlbnQpO1xyXG4gICAgICB0aGlzLmltYWdlLmltYWdlID0gdGhpcy5jcm9wcGVyLmdldENyb3BwZWRJbWFnZUhlbHBlcigpLnNyYztcclxuICAgICAgdGhpcy5vbkNyb3AuZW1pdCh0aGlzLmNyb3BwZXIuZ2V0Q3JvcEJvdW5kcygpKTtcclxuICAgICAgdGhpcy51cGRhdGVDcm9wQm91bmRzKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgb25Nb3VzZU1vdmUoZXZlbnQ6IE1vdXNlRXZlbnQpOiB2b2lkIHtcclxuICAgIHRoaXMuY3JvcHBlci5vbk1vdXNlTW92ZShldmVudCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZmlsZUNoYW5nZUxpc3RlbmVyKCRldmVudDogYW55KSB7XHJcbiAgICBpZiAoJGV2ZW50LnRhcmdldC5maWxlcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGZpbGU6IEZpbGUgPSAkZXZlbnQudGFyZ2V0LmZpbGVzWzBdO1xyXG4gICAgaWYgKHRoaXMuc2V0dGluZ3MuYWxsb3dlZEZpbGVzUmVnZXgudGVzdChmaWxlLm5hbWUpKSB7XHJcbiAgICAgIGNvbnN0IGltYWdlOiBhbnkgPSBuZXcgSW1hZ2UoKTtcclxuICAgICAgY29uc3QgZmlsZVJlYWRlcjogRmlsZVJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7XHJcblxyXG4gICAgICBmaWxlUmVhZGVyLmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWRlbmQnLCAobG9hZEV2ZW50OiBhbnkpID0+IHtcclxuICAgICAgICBpbWFnZS5hZGRFdmVudExpc3RlbmVyKCdsb2FkJywgKCkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5zZXRJbWFnZShpbWFnZSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgaW1hZ2Uuc3JjID0gbG9hZEV2ZW50LnRhcmdldC5yZXN1bHQ7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgZmlsZVJlYWRlci5yZWFkQXNEYXRhVVJMKGZpbGUpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSByZXNpemUoKSB7XHJcbiAgICBjb25zdCBjYW52YXM6IEhUTUxDYW52YXNFbGVtZW50ID0gdGhpcy5jcm9wY2FudmFzLm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICB0aGlzLnNldHRpbmdzLmNhbnZhc1dpZHRoID0gY2FudmFzLm9mZnNldFdpZHRoO1xyXG4gICAgdGhpcy5zZXR0aW5ncy5jYW52YXNIZWlnaHQgPSBjYW52YXMub2Zmc2V0SGVpZ2h0O1xyXG4gICAgdGhpcy5jcm9wcGVyLnJlc2l6ZUNhbnZhcyhjYW52YXMub2Zmc2V0V2lkdGgsIGNhbnZhcy5vZmZzZXRIZWlnaHQsIHRydWUpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHJlc2V0KCk6IHZvaWQge1xyXG4gICAgdGhpcy5jcm9wcGVyLnJlc2V0KCk7XHJcbiAgICB0aGlzLnJlbmRlcmVyLnNldEF0dHJpYnV0ZShcclxuICAgICAgdGhpcy5jcm9wY2FudmFzLm5hdGl2ZUVsZW1lbnQsXHJcbiAgICAgICdjbGFzcycsXHJcbiAgICAgIHRoaXMuc2V0dGluZ3MuY3JvcHBlckNsYXNzXHJcbiAgICApO1xyXG4gICAgdGhpcy5pbWFnZS5pbWFnZSA9IHRoaXMuY3JvcHBlci5nZXRDcm9wcGVkSW1hZ2VIZWxwZXIoKS5zcmM7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc2V0SW1hZ2UoaW1hZ2U6IEhUTUxJbWFnZUVsZW1lbnQsIG5ld0JvdW5kczogYW55ID0gbnVsbCkge1xyXG4gICAgdGhpcy5pbWFnZVNldC5lbWl0KHRydWUpO1xyXG4gICAgdGhpcy5yZW5kZXJlci5zZXRBdHRyaWJ1dGUoXHJcbiAgICAgIHRoaXMuY3JvcGNhbnZhcy5uYXRpdmVFbGVtZW50LFxyXG4gICAgICAnY2xhc3MnLFxyXG4gICAgICBgJHt0aGlzLnNldHRpbmdzLmNyb3BwZXJDbGFzc30gJHt0aGlzLnNldHRpbmdzLmNyb3BwaW5nQ2xhc3N9YFxyXG4gICAgKTtcclxuICAgIHRoaXMucmFmID0gd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XHJcbiAgICAgIGlmICh0aGlzLnJhZikge1xyXG4gICAgICAgIHdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZSh0aGlzLnJhZik7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKGltYWdlLm5hdHVyYWxIZWlnaHQgPiAwICYmIGltYWdlLm5hdHVyYWxXaWR0aCA+IDApIHtcclxuICAgICAgICBpbWFnZS5oZWlnaHQgPSBpbWFnZS5uYXR1cmFsSGVpZ2h0O1xyXG4gICAgICAgIGltYWdlLndpZHRoID0gaW1hZ2UubmF0dXJhbFdpZHRoO1xyXG5cclxuICAgICAgICB3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUodGhpcy5yYWYpO1xyXG4gICAgICAgIHRoaXMuZ2V0T3JpZW50ZWRJbWFnZShpbWFnZSwgKGltZzogSFRNTEltYWdlRWxlbWVudCkgPT4ge1xyXG4gICAgICAgICAgaWYgKHRoaXMuc2V0dGluZ3MuZHluYW1pY1NpemluZykge1xyXG4gICAgICAgICAgICBjb25zdCBjYW52YXM6IEhUTUxDYW52YXNFbGVtZW50ID0gdGhpcy5jcm9wY2FudmFzLm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0dGluZ3MuY2FudmFzV2lkdGggPSBjYW52YXMub2Zmc2V0V2lkdGg7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0dGluZ3MuY2FudmFzSGVpZ2h0ID0gY2FudmFzLm9mZnNldEhlaWdodDtcclxuICAgICAgICAgICAgdGhpcy5jcm9wcGVyLnJlc2l6ZUNhbnZhcyhcclxuICAgICAgICAgICAgICBjYW52YXMub2Zmc2V0V2lkdGgsXHJcbiAgICAgICAgICAgICAgY2FudmFzLm9mZnNldEhlaWdodCxcclxuICAgICAgICAgICAgICBmYWxzZVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIHRoaXMuY3JvcHBlci5zZXRJbWFnZShpbWcpO1xyXG4gICAgICAgICAgaWYgKHRoaXMuY3JvcFBvc2l0aW9uICYmIHRoaXMuY3JvcFBvc2l0aW9uLmlzSW5pdGlhbGl6ZWQoKSkge1xyXG4gICAgICAgICAgICB0aGlzLmNyb3BwZXIudXBkYXRlQ3JvcFBvc2l0aW9uKHRoaXMuY3JvcFBvc2l0aW9uLnRvQm91bmRzKCkpO1xyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIHRoaXMuaW1hZ2Uub3JpZ2luYWwgPSBpbWc7XHJcbiAgICAgICAgICBsZXQgYm91bmRzID0gdGhpcy5jcm9wcGVyLmdldENyb3BCb3VuZHMoKTtcclxuICAgICAgICAgIHRoaXMuaW1hZ2UuaW1hZ2UgPSB0aGlzLmNyb3BwZXIuZ2V0Q3JvcHBlZEltYWdlSGVscGVyKCkuc3JjO1xyXG5cclxuICAgICAgICAgIGlmICghdGhpcy5pbWFnZSkge1xyXG4gICAgICAgICAgICB0aGlzLmltYWdlID0gaW1hZ2U7XHJcbiAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgaWYgKG5ld0JvdW5kcyAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIGJvdW5kcyA9IG5ld0JvdW5kcztcclxuICAgICAgICAgICAgdGhpcy5jcm9wcGVyLnNldEJvdW5kcyhib3VuZHMpO1xyXG4gICAgICAgICAgICB0aGlzLmNyb3BwZXIudXBkYXRlQ3JvcFBvc2l0aW9uKGJvdW5kcyk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICB0aGlzLm9uQ3JvcC5lbWl0KGJvdW5kcyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBpc0Nyb3BQb3NpdGlvbkNoYW5nZWQoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IGJvb2xlYW4ge1xyXG4gICAgaWYgKFxyXG4gICAgICB0aGlzLmNyb3BwZXIgJiZcclxuICAgICAgY2hhbmdlcy5jcm9wUG9zaXRpb24gJiZcclxuICAgICAgdGhpcy5pc0Nyb3BQb3NpdGlvblVwZGF0ZU5lZWRlZFxyXG4gICAgKSB7XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5pc0Nyb3BQb3NpdGlvblVwZGF0ZU5lZWRlZCA9IHRydWU7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgdXBkYXRlQ3JvcEJvdW5kcygpOiB2b2lkIHtcclxuICAgIGNvbnN0IGNyb3BCb3VuZDogQm91bmRzID0gdGhpcy5jcm9wcGVyLmdldENyb3BCb3VuZHMoKTtcclxuICAgIHRoaXMuY3JvcFBvc2l0aW9uQ2hhbmdlLmVtaXQoXHJcbiAgICAgIG5ldyBDcm9wUG9zaXRpb24oXHJcbiAgICAgICAgY3JvcEJvdW5kLmxlZnQsXHJcbiAgICAgICAgY3JvcEJvdW5kLnRvcCxcclxuICAgICAgICBjcm9wQm91bmQud2lkdGgsXHJcbiAgICAgICAgY3JvcEJvdW5kLmhlaWdodFxyXG4gICAgICApXHJcbiAgICApO1xyXG4gICAgdGhpcy5pc0Nyb3BQb3NpdGlvblVwZGF0ZU5lZWRlZCA9IGZhbHNlO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRPcmllbnRlZEltYWdlKFxyXG4gICAgaW1hZ2U6IEhUTUxJbWFnZUVsZW1lbnQsXHJcbiAgICBjYWxsYmFjazogKGltZzogSFRNTEltYWdlRWxlbWVudCkgPT4gdm9pZFxyXG4gICkge1xyXG4gICAgbGV0IGltZzogYW55O1xyXG5cclxuICAgIHRoaXMuZXhpZi5nZXREYXRhKGltYWdlLCAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IG9yaWVudGF0aW9uID0gdGhpcy5leGlmLmdldFRhZyhpbWFnZSwgJ09yaWVudGF0aW9uJyk7XHJcblxyXG4gICAgICBpZiAoWzMsIDYsIDhdLmluZGV4T2Yob3JpZW50YXRpb24pID4gLTEpIHtcclxuICAgICAgICBjb25zdCBjYW52YXM6IEhUTUxDYW52YXNFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7XHJcbiAgICAgICAgY29uc3QgY3R4OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQgPSBjYW52YXMuZ2V0Q29udGV4dChcclxuICAgICAgICAgICcyZCdcclxuICAgICAgICApIGFzIENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRDtcclxuICAgICAgICBsZXQgY3c6IG51bWJlciA9IGltYWdlLndpZHRoO1xyXG4gICAgICAgIGxldCBjaDogbnVtYmVyID0gaW1hZ2UuaGVpZ2h0O1xyXG4gICAgICAgIGxldCBjeCA9IDA7XHJcbiAgICAgICAgbGV0IGN5ID0gMDtcclxuICAgICAgICBsZXQgZGVnID0gMDtcclxuXHJcbiAgICAgICAgc3dpdGNoIChvcmllbnRhdGlvbikge1xyXG4gICAgICAgICAgY2FzZSAzOlxyXG4gICAgICAgICAgICBjeCA9IC1pbWFnZS53aWR0aDtcclxuICAgICAgICAgICAgY3kgPSAtaW1hZ2UuaGVpZ2h0O1xyXG4gICAgICAgICAgICBkZWcgPSAxODA7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgY2FzZSA2OlxyXG4gICAgICAgICAgICBjdyA9IGltYWdlLmhlaWdodDtcclxuICAgICAgICAgICAgY2ggPSBpbWFnZS53aWR0aDtcclxuICAgICAgICAgICAgY3kgPSAtaW1hZ2UuaGVpZ2h0O1xyXG4gICAgICAgICAgICBkZWcgPSA5MDtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICBjYXNlIDg6XHJcbiAgICAgICAgICAgIGN3ID0gaW1hZ2UuaGVpZ2h0O1xyXG4gICAgICAgICAgICBjaCA9IGltYWdlLndpZHRoO1xyXG4gICAgICAgICAgICBjeCA9IC1pbWFnZS53aWR0aDtcclxuICAgICAgICAgICAgZGVnID0gMjcwO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY2FudmFzLndpZHRoID0gY3c7XHJcbiAgICAgICAgY2FudmFzLmhlaWdodCA9IGNoO1xyXG4gICAgICAgIGN0eC5yb3RhdGUoKGRlZyAqIE1hdGguUEkpIC8gMTgwKTtcclxuICAgICAgICBjdHguZHJhd0ltYWdlKGltYWdlLCBjeCwgY3kpO1xyXG4gICAgICAgIGltZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2ltZycpO1xyXG4gICAgICAgIGltZy53aWR0aCA9IGN3O1xyXG4gICAgICAgIGltZy5oZWlnaHQgPSBjaDtcclxuICAgICAgICBpbWcuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsICgpID0+IHtcclxuICAgICAgICAgIGNhbGxiYWNrKGltZyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgaW1nLnNyYyA9IGNhbnZhcy50b0RhdGFVUkwoJ2ltYWdlL3BuZycpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGltZyA9IGltYWdlO1xyXG4gICAgICAgIGNhbGxiYWNrKGltZyk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxufVxyXG4iXX0=